<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    // Your access token can be found at: https://ion.cesium.com/tokens.
    // This is the default access token from your ion account

    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    // å…ˆåˆ›å»ºåœ°å½¢æä¾›è€…
    const terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(1, {
      requestVertexNormals: true,
      requestWaterMask: true
    });

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true,
      terrainProvider: terrainProvider
    });

    // å­˜å‚¨åˆ›å»ºçš„å®ä½“
    let droneEntity = null;
    let rayEntities = [];

    //åŠ è½½ 3D Tilesetï¼ˆè‡ªåŠ¨è§£æ B3DMï¼‰
    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl(
        "http://192.168.4.78:8000/tileset.json",
        {
          debugShowBoundingVolume: true, // ä¼˜åŒ–åŠ¨æ€åŠ è½½
        })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      console.log(`æ­£åœ¨åŠ è½½: ${numberOfPendingRequests} ä¸ªè¯·æ±‚`);
    });

    // å®šä½åˆ° Tileset
    viewer.zoomTo(tileset);



    // ç›‘å¬é¼ æ ‡ç‚¹å‡»äº‹ä»¶
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
    const infoBox = document.getElementById('infoBox');

    viewer.canvas.addEventListener('click', async (event) => {
      // æ¸…é™¤ä¹‹å‰çš„æ— äººæœºå’Œå°„çº¿
      if (droneEntity) {
        viewer.entities.remove(droneEntity);
        droneEntity = null;
      }

      // æ¸…é™¤ä¹‹å‰çš„å°„çº¿å®ä½“
      rayEntities.forEach(entity => {
        viewer.entities.remove(entity);
      });
      rayEntities = [];

      // è·å–é¼ æ ‡åœ¨ç”»å¸ƒä¸­çš„ç›¸å¯¹åæ ‡
      const rect = viewer.canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      const clickPosition = new Cesium.Cartesian2(x, y);

      // æ£€æµ‹åœ°å½¢äº¤ç‚¹
      const cartesian = viewer.scene.pickPosition(clickPosition);
      if (!cartesian) {
        console.log("æœªæ‹¾å–åˆ°æ¨¡å‹æˆ–åœ°å½¢");
        return;
      }

      const cartographic_click = Cesium.Cartographic.fromCartesian(cartesian);
      // const longitude_click = Cesium.Math.toDegrees(cartographic_click.longitude).toFixed(6);
      // const latitude_click = Cesium.Math.toDegrees(cartographic_click.latitude).toFixed(6);
      // const height_click = cartographic_click.height.toFixed(2) + 500;

      const longitude_click = 119.9980574;
      const latitude_click = 30.28275965;
      const height_click = 300;

      console.log("ç‚¹å‡»åæ ‡ï¼ˆç»çº¬åº¦ï¼‰:", { longitude_click, latitude_click, height_click });

      // è·å–åœ°å½¢é«˜åº¦
      const terrainSample = await Cesium.sampleTerrainMostDetailed(
        viewer.terrainProvider,
        [new Cesium.Cartographic(
          Cesium.Math.toRadians(longitude_click),
          Cesium.Math.toRadians(latitude_click)
        )]
      );

      if (!terrainSample || terrainSample.length === 0) {
        console.error("æ— æ³•è·å–åœ°å½¢é«˜åº¦");
        return;
      }

      // 2. è·å–åœ°å½¢é«˜åº¦
      const terrainHeight = terrainSample[0].height;

      // åˆ›å»ºæ— äººæœºä½ç½®
      const dronePositionCartesian = Cesium.Cartesian3.fromDegrees(
        longitude_click,
        latitude_click,
        height_click
      );

      const airplaneUri = await Cesium.IonResource.fromAssetId(3472138);

      const heading = Cesium.Math.toRadians(-90); // æ°´å¹³æ–¹å‘åè½¬90åº¦
      const pitch = Cesium.Math.toRadians(0);    // ä¿¯ä»°è§’ 0 åº¦
      const roll = Cesium.Math.toRadians(0);     // æ»šè½¬è§’ 0 åº¦

      const hpr = new Cesium.HeadingPitchRoll(heading, pitch, roll);
      const orientation = Cesium.Transforms.headingPitchRollQuaternion(
        dronePositionCartesian, // æ— äººæœºçš„å½“å‰ä½ç½®
        hpr
      );

      // åˆ›å»ºæ–°çš„æ— äººæœºå®ä½“
      droneEntity = viewer.entities.add({
        name: "æ— äººæœº",
        position: dronePositionCartesian,
        orientation: orientation, // å…³é”®ï¼šè®¾ç½®æ–¹å‘
        model: {
          uri: airplaneUri, // Cesiumæ— äººæœºæ¨¡å‹
          scale: 5.0,
          minimumPixelSize: 64
        }
      });

      viewer.zoomTo(droneEntity); // è§†è§’èšç„¦åˆ°æ— äººæœº

      // æ–¹æ³•2ï¼šå¤šæ–¹å‘å°„çº¿æ£€æµ‹ï¼ˆè¡¥å……æ–¹æ¡ˆï¼‰
      const directions = [
        Cesium.Cartesian3.negate(Cesium.Cartesian3.UNIT_Z, new Cesium.Cartesian3())  // ä¸‹
      ];

      let collisionDetected = false;

      directions.forEach(dir => {
        const ray = new Cesium.Ray(
          dronePositionCartesian,
          dir // å‘ä¸‹å‘å°„å°„çº¿ï¼ˆå–åZè½´ï¼‰
        );

        // å¯è§†åŒ–å°„çº¿å¹¶å­˜å‚¨å®ä½“
        const rayEntity = viewer.entities.add({
          polyline: {
            positions: [
              dronePositionCartesian,
              Cesium.Cartesian3.add(
                dronePositionCartesian,
                Cesium.Cartesian3.multiplyByScalar(
                  dir,
                  1000,
                  new Cesium.Cartesian3()
                ),
                new Cesium.Cartesian3()
              )
            ],
            width: 2,
            material: Cesium.Color.RED
          }
        });
        rayEntities.push(rayEntity);

        //console.log('æ— äººæœºå°„çº¿èµ·ç‚¹:', ray.origin);

        const cartographic = Cesium.Cartographic.fromCartesian(ray.origin);
        const height = cartographic.height;
        //console.log('æ— äººæœºå°„çº¿æ–¹å‘:', ray.direction);

        // drillPickFromRay è·å–å°„çº¿ç©¿é€çš„æ‰€æœ‰ç‰©ä½“
        const hitPoint = viewer.scene.pickFromRay(ray);
        if (!hitPoint) {
          console.log("âŒ å°„çº¿æœªç©¿è¿‡ä»»ä½•å»ºç­‘ç‰©");
          return;
        }

        let changedCount = 0;

        if (hitPoint.position) {
          const cartographicHit = Cesium.Cartographic.fromCartesian(hitPoint.position);

          const distance = Cesium.Cartesian3.distance(dronePositionCartesian, hitPoint.position);


          // 5. è®¡ç®—å»ºç­‘ç‰©é«˜åº¦
          const buildingHeight = Math.max(0, cartographicHit.height - terrainHeight).toFixed(2);


          console.log(
            `ğŸ“ ç¢°æ’ç‚¹: ç»åº¦=${Cesium.Math.toDegrees(cartographicHit.longitude).toFixed(6)}, ` +
            `çº¬åº¦=${Cesium.Math.toDegrees(cartographicHit.latitude).toFixed(6)}, ` +
            `åœ°å½¢é«˜åº¦=${terrainHeight.toFixed(2)} ç±³, ` +
            `å»ºç­‘ç‰©é«˜åº¦=${buildingHeight} ç±³, ` +
            `è·ç¦»=${distance.toFixed(2)} ç±³`

          );

          if (distance < 100) {
            console.log("ğŸ¨ ç¬¦åˆæ¡ä»¶ï¼Œä¿®æ”¹é¢œè‰²");

            changedCount++;

            // å¯è§†åŒ–å‘½ä¸­ç‚¹å¹¶å­˜å‚¨å®ä½“
            const hitEntity = viewer.entities.add({
              position: hitPoint.position,
              point: {
                pixelSize: 50,
                color: Cesium.Color.RED
              }
            });
            rayEntities.push(hitEntity);
          } else {
            console.log("âš ï¸ è·ç¦»å¤§äº100mï¼Œè·³è¿‡");
          }
        }

        if (changedCount === 0) {
          console.log("âœ… å°„çº¿ç©¿é€ä½†æ— å»ºç­‘ç‰©è·ç¦»<200m");
        }
      });
    });
  </script>
</body>

</html>