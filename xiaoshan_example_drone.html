<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    // Your access token can be found at: https://ion.cesium.com/tokens.
    // This is the default access token from your ion account

    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true
    });

    // currentTileset = viewer.scene.primitives.add(
    //   await Cesium.Cesium3DTileset.fromUrl(
    //     `http://localhost:5173/assets/0_0_0-2_1_1/tileset.json`,
    //     {
    //       debugShowBoundingVolume: true,
    //     }
    //   )
    // );


    //åŠ è½½ 3D Tilesetï¼ˆè‡ªåŠ¨è§£æ B3DMï¼‰
    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl(
        "http://localhost:5173/assets/xiaoshan_3dtiles/tileset.json",
        {
          debugShowBoundingVolume: true, // ä¼˜åŒ–åŠ¨æ€åŠ è½½
        })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      console.log(`æ­£åœ¨åŠ è½½: ${numberOfPendingRequests} ä¸ªè¯·æ±‚`);
    });

    // å®šä½åˆ° Tileset
    viewer.zoomTo(tileset);


    viewer.canvas.addEventListener('click', async (event) => {
      // æ— äººæœºç»çº¬åº¦é«˜åº¦ (å•ä½ï¼šåº¦ã€ç±³)
      // const droneLongitude = 120.2;
      // const droneLatitude = 30.3;
      // const droneHeight = 196.0;
      // è·å–ç‚¹å‡»çš„ç¬›å¡å°”åæ ‡ï¼ˆåŸºäºæ¤­çƒä½“ï¼‰
      // è·å–é¼ æ ‡åœ¨ç”»å¸ƒä¸­çš„ç›¸å¯¹åæ ‡
      const rect = viewer.canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      const clickPosition = new Cesium.Cartesian2(x, y);

      // è·å–å°„çº¿
      const ray_click = viewer.camera.getPickRay(clickPosition);
      if (!ray_click) {
        console.log("æ— æ³•ç”Ÿæˆå°„çº¿");
        return;
      }

      // æ£€æµ‹åœ°å½¢äº¤ç‚¹
      const cartesian = viewer.scene.globe.pick(ray_click, viewer.scene);
      if (!cartesian) {
        console.log("æœªç‚¹å‡»åˆ°åœ°å½¢");
        return;
      }

      // è½¬æ¢ä¸ºç»çº¬åº¦å’Œé«˜åº¦
      const cartographic_click = Cesium.Cartographic.fromCartesian(cartesian);
      const longitude_click = Cesium.Math.toDegrees(cartographic_click.longitude);
      const latitude_click = Cesium.Math.toDegrees(cartographic_click.latitude);
      const height_click = cartographic_click.height + 100.0; // åœ¨åœ°å½¢é«˜åº¦ä¸Š+100ç±³

      console.log("ç‚¹å‡»åæ ‡ï¼ˆç»çº¬åº¦ï¼‰:", { longitude_click, latitude_click, height_click });


      //{longitude_click: 120.40771692106641, latitude_click: 30.167899447194028, height_click: 99.99887779547129}
      // åˆ›å»ºæ— äººæœºä½ç½®
      const dronePositionCartesian = Cesium.Cartesian3.fromDegrees(
        longitude_click,
        latitude_click,
        height_click
      );


      // æ·»åŠ æ— äººæœºå®ä½“
      // const droneEntity = viewer.entities.add({
      //   name: "æ— äººæœº",
      //   position: dronePositionCartesian,
      //   box: {
      //     dimensions: new Cesium.Cartesian3(5.0, 5.0, 2.0),
      //     material: Cesium.Color.YELLOW.withAlpha(0.8),
      //     outline: true,
      //     outlineColor: Cesium.Color.RED
      //   }
      // });

      const airplaneUri = await Cesium.IonResource.fromAssetId(3472138);

      const heading = Cesium.Math.toRadians(-90); // æ°´å¹³æ–¹å‘åè½¬90åº¦
      const pitch = Cesium.Math.toRadians(0);    // ä¿¯ä»°è§’ 0 åº¦
      const roll = Cesium.Math.toRadians(0);     // æ»šè½¬è§’ 0 åº¦

      const hpr = new Cesium.HeadingPitchRoll(heading, pitch, roll);
      const orientation = Cesium.Transforms.headingPitchRollQuaternion(
        dronePositionCartesian, // æ— äººæœºçš„å½“å‰ä½ç½®
        hpr
      );

      //æˆ–è€…ï¼šä½¿ç”¨GLTFæ¨¡å‹ï¼ˆæ›´çœŸå®ï¼‰
      const droneEntity = viewer.entities.add({
        name: "æ— äººæœº",
        position: dronePositionCartesian,
        orientation: orientation, // å…³é”®ï¼šè®¾ç½®æ–¹å‘
        model: {
          uri: airplaneUri, // Cesiumæ— äººæœºæ¨¡å‹
          scale: 5.0,
          minimumPixelSize: 64
        }
      });

      viewer.zoomTo(droneEntity); // è§†è§’èšç„¦åˆ°æ— äººæœº

      // ä»¥æ— äººæœºä¸ºèµ·ç‚¹ï¼Œæ²¿ç›¸æœºè§†çº¿æ–¹å‘å‘å°„å°„çº¿
      // const cameraDirection = Cesium.Cartesian3.normalize(
      //   viewer.camera.directionWC,
      //   new Cesium.Cartesian3()
      // );

      // // ä»¥æ— äººæœºä¸ºèµ·ç‚¹å‘å°„å°„çº¿
      // const ray = new Cesium.Ray(
      //   dronePositionCartesian,
      //   cameraDirection
      // );
      // ä»¥æ— äººæœºä¸ºèµ·ç‚¹å‘å°„å°„çº¿

      const cameraDirection = Cesium.Cartesian3.negate(Cesium.Cartesian3.UNIT_Z, new Cesium.Cartesian3())
      const ray = new Cesium.Ray(
        dronePositionCartesian,
        cameraDirection // å‘ä¸‹å‘å°„å°„çº¿ï¼ˆå–åZè½´ï¼‰
      );

      // å¯è§†åŒ–å°„çº¿
      viewer.entities.add({
        polyline: {
          positions: [
            dronePositionCartesian,
            Cesium.Cartesian3.add(
              dronePositionCartesian,
              Cesium.Cartesian3.multiplyByScalar(
                cameraDirection,
                1000,
                new Cesium.Cartesian3()
              ),
              new Cesium.Cartesian3()
            )
          ],
          width: 2,
          material: Cesium.Color.RED
        }
      });

      console.log('å°„çº¿èµ·ç‚¹:', ray.origin);

      const cartographic = Cesium.Cartographic.fromCartesian(ray.origin);
      const height = cartographic.height;
      console.log(`å°„çº¿èµ·ç‚¹æµ·æ‹”é«˜åº¦: ${height.toFixed(2)} ç±³`);
      console.log('å°„çº¿æ–¹å‘:', ray.direction);

      // drillPickFromRay è·å–å°„çº¿ç©¿é€çš„æ‰€æœ‰ç‰©ä½“
      const result = viewer.scene.pickFromRay(ray); // ç¬¬äºŒä¸ªå‚æ•°é™åˆ¶10ä¸ªç‰©ä½“
      if (!result) {
        console.log("âŒ å°„çº¿æœªç©¿è¿‡ä»»ä½•å»ºç­‘ç‰©");
        return;
      }

      let changedCount = 0;

      // for (const result of results) {
      //if (result instanceof Cesium.Cesium3DTileFeature) {
      // è®¡ç®—å°„çº¿ä¸è¯¥ç‰©ä½“çš„ç›¸äº¤ä½ç½®
      const intersection = viewer.scene.pickFromRay(ray, [result]);
      if (intersection && intersection.position) {
        const hitPoint = intersection.position;
        const cartographicHit = Cesium.Cartographic.fromCartesian(hitPoint);
        console.log('ç¢°æ’ç‚¹ç»åº¦:', Cesium.Math.toDegrees(cartographicHit.longitude));
        console.log('ç¢°æ’ç‚¹çº¬åº¦:', Cesium.Math.toDegrees(cartographicHit.latitude));
        console.log('ç¢°æ’ç‚¹é«˜åº¦:', cartographicHit.height);
        const distance = Cesium.Cartesian3.distance(dronePositionCartesian, hitPoint);

        console.log(`ğŸ“ æ— äººæœºåˆ°è¯¥ç‰©ä½“çš„è·ç¦»: ${distance.toFixed(2)} ç±³`);

        if (distance < 500) {
          console.log("ğŸ¨ ç¬¦åˆæ¡ä»¶ï¼Œä¿®æ”¹é¢œè‰²");
          result.color = Cesium.Color.BLUE.withAlpha(0.5);
          changedCount++;

          // ç›´æ¥æ”¹å˜å»ºç­‘ç‰©é¢œè‰²ï¼ˆè€Œä¸æ˜¯åŠ çº¢ç‚¹ï¼‰
          //result.color = Cesium.Color.BLUE.withAlpha(0.5);
          // å¯è§†åŒ–å‘½ä¸­ç‚¹
          viewer.entities.add({
            position: hitPoint,
            point: {
              pixelSize: 50,
              color: Cesium.Color.RED
            }
          });
        } else {
          console.log("âš ï¸ è·ç¦»å¤§äº200mï¼Œè·³è¿‡");
        }
      }
      //}
      //   }

      if (changedCount === 0) {
        console.log("âœ… å°„çº¿ç©¿é€ä½†æ— å»ºç­‘ç‰©è·ç¦»<200m");
      }
    });
  </script>
</body>

</html>