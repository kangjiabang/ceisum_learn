<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    // Your access token can be found at: https://ion.cesium.com/tokens.
    // This is the default access token from your ion account

    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true
    });

    // currentTileset = viewer.scene.primitives.add(
    //   await Cesium.Cesium3DTileset.fromUrl(
    //     `http://localhost:5173/assets/0_0_0-2_1_1/tileset.json`,
    //     {
    //       debugShowBoundingVolume: true,
    //     }
    //   )
    // );

    //åŠ è½½ 3D Tilesetï¼ˆè‡ªåŠ¨è§£æ B3DMï¼‰
    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl(
        "http://localhost:5173/assets/xiaoshan_3dtiles/tileset.json",
        {
          debugShowBoundingVolume: true, // ä¼˜åŒ–åŠ¨æ€åŠ è½½
        })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      console.log(`æ­£åœ¨åŠ è½½: ${numberOfPendingRequests} ä¸ªè¯·æ±‚`);
    });

    // å®šä½åˆ° Tileset
    viewer.zoomTo(tileset);


    viewer.canvas.addEventListener('click', async (event) => {
      const rect = viewer.canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      const ray = viewer.camera.getPickRay(new Cesium.Cartesian2(x, y));
      if (!ray) {
        console.log("âš ï¸ æ— æ³•ç”Ÿæˆå°„çº¿");
        return;
      }

      const cartographic = Cesium.Cartographic.fromCartesian(ray.origin);
      const height = cartographic.height;
      const longitude = Cesium.Math.toDegrees(cartographic.longitude);
      const latitude = Cesium.Math.toDegrees(cartographic.latitude);

      console.log(`ğŸš€ å°„çº¿èµ·ç‚¹åæ ‡ï¼šç»åº¦=${longitude.toFixed(6)}Â°, çº¬åº¦=${latitude.toFixed(6)}Â°, é«˜åº¦=${height.toFixed(2)} ç±³`);

      console.log('å°„çº¿æ–¹å‘:', ray.direction);

      // drillPickFromRay è·å–å°„çº¿ç©¿é€çš„æ‰€æœ‰ç‰©ä½“
      const results = viewer.scene.drillPickFromRay(ray, 10); // ç¬¬äºŒä¸ªå‚æ•°é™åˆ¶10ä¸ªç‰©ä½“
      if (results.length === 0) {
        console.log("âŒ å°„çº¿æœªç©¿è¿‡ä»»ä½•å»ºç­‘ç‰©");
        return;
      }

      let changedCount = 0;

      for (const result of results) {
        //if (result instanceof Cesium.Cesium3DTileFeature) {
        // è®¡ç®—å°„çº¿ä¸è¯¥ç‰©ä½“çš„ç›¸äº¤ä½ç½®
        const intersection = viewer.scene.pickFromRay(ray, [result]);
        if (intersection && intersection.position) {
          const hitPoint = intersection.position;
          const cameraPosition = viewer.camera.positionWC;
          const distance = Cesium.Cartesian3.distance(cameraPosition, hitPoint);

          console.log(`ğŸ“ ç›¸æœºåˆ°è¯¥ç‰©ä½“çš„è·ç¦»: ${distance.toFixed(2)} ç±³`);

          if (distance < 500) {
            console.log("ğŸ¨ ç¬¦åˆæ¡ä»¶ï¼Œä¿®æ”¹é¢œè‰²");
            result.color = Cesium.Color.BLUE.withAlpha(0.5);
            changedCount++;

            // ç›´æ¥æ”¹å˜å»ºç­‘ç‰©é¢œè‰²ï¼ˆè€Œä¸æ˜¯åŠ çº¢ç‚¹ï¼‰
            //result.color = Cesium.Color.BLUE.withAlpha(0.5);
            // å¯è§†åŒ–å‘½ä¸­ç‚¹
            viewer.entities.add({
              position: hitPoint,
              point: {
                pixelSize: 20,
                color: Cesium.Color.RED
              }
            });
          } else {
            console.log("âš ï¸ è·ç¦»å¤§äº200mï¼Œè·³è¿‡");
          }
        }
        //}
      }

      if (changedCount === 0) {
        console.log("âœ… å°„çº¿ç©¿é€ä½†æ— å»ºç­‘ç‰©è·ç¦»<200m");
      }
    });
  </script>
</body>

</html>