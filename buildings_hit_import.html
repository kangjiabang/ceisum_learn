<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <!-- 引入你的二方包 -->
  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">

    // 导入二方包
    import { ObstacleDetector } from '@your-org/drone-obstacle-detector';

    // Your access token can be found at: https://ion.cesium.com/tokens.    
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    // 先创建地形提供者
    const terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(1, {
      requestVertexNormals: true,
      requestWaterMask: true
    });

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true,
      terrainProvider: terrainProvider
    });

    //加载 3D Tileset（自动解析 B3DM）
    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl(
        "http://192.168.4.78:8000/tileset.json",
        {
          debugShowBoundingVolume: true,
        })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      console.log(`正在加载: ${numberOfPendingRequests} 个请求`);
    });

    // 定位到 Tileset
    viewer.zoomTo(tileset);
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
    let droneEntity = null;
    let detectionIntervalId = null;

    // 无人机航线（经纬度+高度）
    const waypoints = [
      { lon: 119.9980574, lat: 30.28275965, height: 100 },
      { lon: 120.0005, lat: 30.2832, height: 100 },
      { lon: 120.0020, lat: 30.2840, height: 100 },
      { lon: 120.0040, lat: 30.2850, height: 100 },
      { lon: 120.0060, lat: 30.2860, height: 100 },
      { lon: 120.0080, lat: 30.2880, height: 100 },
      { lon: 120.0100, lat: 30.2900, height: 100 }
    ];



    (async function initDroneFlight() {
      try {
        // 构建航迹
        const positionProperty = new Cesium.SampledPositionProperty();
        let startTime = Cesium.JulianDate.now();
        let timeStep = 10; // 每段航点的飞行时间（秒）

        for (let i = 0; i < waypoints.length; i++) {
          const wp = waypoints[i];
          const terrainSample = await Cesium.sampleTerrainMostDetailed(
            viewer.terrainProvider,
            [new Cesium.Cartographic(
              Cesium.Math.toRadians(wp.lon),
              Cesium.Math.toRadians(wp.lat)
            )]
          );
          const terrainHeight = terrainSample[0].height;

          const pos = Cesium.Cartesian3.fromDegrees(wp.lon, wp.lat, wp.height);
          const time = Cesium.JulianDate.addSeconds(startTime, i * timeStep, new Cesium.JulianDate());
          positionProperty.addSample(time, pos);
        }

        // 设置飞行时间范围
        const totalTime = timeStep * (waypoints.length - 1);
        viewer.clock.startTime = startTime.clone();
        viewer.clock.stopTime = Cesium.JulianDate.addSeconds(startTime, totalTime, new Cesium.JulianDate());
        viewer.clock.currentTime = startTime.clone();
        viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP; // 循环
        viewer.clock.multiplier = 1 * 0.5; // 时间倍率

        // 无人机模型
        droneEntity = viewer.entities.add({
          availability: new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({
            start: viewer.clock.startTime,
            stop: viewer.clock.stopTime
          })]),
          position: positionProperty,
          orientation: new Cesium.VelocityOrientationProperty(positionProperty),
          model: {
            uri: "models/drone_costum.glb",
            scale: 5.0,
            minimumPixelSize: 64,
            allowPicking: false // 关键
          }
        });

        viewer.clock.shouldAnimate = true; // 启动时间动画
        viewer.trackedEntity = droneEntity; // 让摄像机跟随无人机（可选）
        viewer.zoomTo(droneEntity);

        // 初始化障碍物检测器
        const detector = new ObstacleDetector(viewer, {
          maxDistance: 200,
          maxResults: 5,
          rayType: 'spherical',
          entityLifetime: 3,
          detectionInterval: 5000 // 5秒检测一次
        });

        // 设置检测完成回调
        detector.setOnDetectionComplete((results) => {
          console.log(`✅ 检测到 ${results.length} 个障碍物`);
        });
        // 每隔 5 秒检测一次障碍物
        // 启动定时检测（传入无人机实体）
        detector.startDetection(droneEntity);

      } catch (error) {
        console.error("初始化无人机飞行时出错:", error);
      }
    })();

  </script>
</body>

</html>