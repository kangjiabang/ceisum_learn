<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <!-- å¼•å…¥ä½ çš„äºŒæ–¹åŒ… -->
  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">

    // å¯¼å…¥äºŒæ–¹åŒ…
    import { ObstacleDetector } from '@your-org/drone-obstacle-detector';

    // Your access token can be found at: https://ion.cesium.com/tokens.    
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    // å…ˆåˆ›å»ºåœ°å½¢æä¾›è€…
    const terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(1, {
      requestVertexNormals: true,
      requestWaterMask: true
    });

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true,
      terrainProvider: terrainProvider
    });

    //åŠ è½½ 3D Tilesetï¼ˆè‡ªåŠ¨è§£æ B3DMï¼‰
    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl(
        "http://192.168.4.78:8000/tileset.json",
        {
          debugShowBoundingVolume: true,
        })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      console.log(`æ­£åœ¨åŠ è½½: ${numberOfPendingRequests} ä¸ªè¯·æ±‚`);
    });

    // å®šä½åˆ° Tileset
    viewer.zoomTo(tileset);
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
    let droneEntity = null;
    let detectionIntervalId = null;

    // æ— äººæœºèˆªçº¿ï¼ˆç»çº¬åº¦+é«˜åº¦ï¼‰
    const waypoints = [
      { lon: 119.9980574, lat: 30.28275965, height: 100 },
      { lon: 120.0005, lat: 30.2832, height: 100 },
      { lon: 120.0020, lat: 30.2840, height: 100 },
      { lon: 120.0040, lat: 30.2850, height: 100 },
      { lon: 120.0060, lat: 30.2860, height: 100 },
      { lon: 120.0080, lat: 30.2880, height: 100 },
      { lon: 120.0100, lat: 30.2900, height: 100 }
    ];

    let isDetectionEnabled = false; // åˆå§‹ä¸æ£€æµ‹
    let autoStopTimer = null;       // 60 ç§’è‡ªåŠ¨åœæ­¢å®šæ—¶å™¨

    (async function initDroneFlight() {
      try {
        // æ„å»ºèˆªè¿¹
        const positionProperty = new Cesium.SampledPositionProperty();
        let startTime = Cesium.JulianDate.now();
        let timeStep = 10; // æ¯æ®µèˆªç‚¹çš„é£è¡Œæ—¶é—´ï¼ˆç§’ï¼‰

        for (let i = 0; i < waypoints.length; i++) {
          const wp = waypoints[i];
          const terrainSample = await Cesium.sampleTerrainMostDetailed(
            viewer.terrainProvider,
            [new Cesium.Cartographic(
              Cesium.Math.toRadians(wp.lon),
              Cesium.Math.toRadians(wp.lat)
            )]
          );
          const terrainHeight = terrainSample[0].height;

          const pos = Cesium.Cartesian3.fromDegrees(wp.lon, wp.lat, wp.height);
          const time = Cesium.JulianDate.addSeconds(startTime, i * timeStep, new Cesium.JulianDate());
          positionProperty.addSample(time, pos);
        }

        // è®¾ç½®é£è¡Œæ—¶é—´èŒƒå›´
        const totalTime = timeStep * (waypoints.length - 1);
        viewer.clock.startTime = startTime.clone();
        viewer.clock.stopTime = Cesium.JulianDate.addSeconds(startTime, totalTime, new Cesium.JulianDate());
        viewer.clock.currentTime = startTime.clone();
        viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP; // å¾ªç¯
        viewer.clock.multiplier = 1 * 0.5; // æ—¶é—´å€ç‡

        // æ— äººæœºæ¨¡å‹
        droneEntity = viewer.entities.add({
          availability: new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({
            start: viewer.clock.startTime,
            stop: viewer.clock.stopTime
          })]),
          position: positionProperty,
          orientation: new Cesium.VelocityOrientationProperty(positionProperty),
          model: {
            uri: "models/drone_costum.glb",
            scale: 5.0,
            minimumPixelSize: 64,
            allowPicking: false // å…³é”®
          }
        });

        viewer.clock.shouldAnimate = true; // å¯åŠ¨æ—¶é—´åŠ¨ç”»
        viewer.trackedEntity = droneEntity; // è®©æ‘„åƒæœºè·Ÿéšæ— äººæœºï¼ˆå¯é€‰ï¼‰
        viewer.zoomTo(droneEntity);


        // æ¯éš” 5 ç§’æ£€æµ‹ä¸€æ¬¡éšœç¢ç‰©
        // å¯åŠ¨å®šæ—¶æ£€æµ‹ï¼ˆä¼ å…¥æ— äººæœºå®ä½“ï¼‰
        // detector.startDetection(droneEntity);

        // ===== ç‚¹å‡»æ— äººæœºåˆ‡æ¢æ£€æµ‹å¼€å…³ =====
        // const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
        // handler.setInputAction((movement) => {
        //   const pickedObject = viewer.scene.pick(movement.position);
        //   if (Cesium.defined(pickedObject) && pickedObject.id === droneEntity) {
        //     isDetectionEnabled = !isDetectionEnabled;
        //     if (isDetectionEnabled) {
        //       console.log("ğŸš€ å¼€å¯éšœç¢ç‰©æ£€æµ‹");
        //       detector.startDetection(droneEntity);
        //     } else {
        //       console.log("ğŸ›‘ åœæ­¢éšœç¢ç‰©æ£€æµ‹");
        //       detector.stopDetection(); // å¦‚æœ ObstacleDetector æä¾› stop æ–¹æ³•
        //     }
        //   }
        // }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        // åˆå§‹åŒ–éšœç¢ç‰©æ£€æµ‹å™¨
        const detector = new ObstacleDetector(viewer, {
          maxDistance: 200,
          maxResults: 5,
          rayType: 'spherical',
          entityLifetime: 3,
          detectionInterval: 5000,// 5ç§’æ£€æµ‹ä¸€æ¬¡
          autoStopTimeout: 15000        // 15ç§’åè‡ªåŠ¨åœæ­¢
        });

        // è®¾ç½®æ£€æµ‹å®Œæˆå›è°ƒ
        detector.setOnDetectionComplete((results) => {
          console.log(`âœ… æ£€æµ‹åˆ° ${results.length} ä¸ªéšœç¢ç‰©`);
        });

        // å¯ç”¨ç‚¹å‡»æ§åˆ¶ï¼ˆç‚¹å‡»æ— äººæœºå®ä½“æ¥å¯åŠ¨/åœæ­¢æ£€æµ‹ï¼‰
        detector.enableClickControl(droneEntity);

      } catch (error) {
        console.error("åˆå§‹åŒ–æ— äººæœºé£è¡Œæ—¶å‡ºé”™:", error);
      }
    })();

  </script>
</body>

</html>