<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    // Your access token can be found at: https://ion.cesium.com/tokens.
    // This is the default access token from your ion account

    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true
    });

    // 存储创建的实体
    let droneEntity = null;
    let rayEntities = [];

    //加载 3D Tileset（自动解析 B3DM）
    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl(
        "http://192.168.4.78:8000/tileset.json",
        {
          debugShowBoundingVolume: true, // 优化动态加载
        })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      console.log(`正在加载: ${numberOfPendingRequests} 个请求`);
    });

    // 定位到 Tileset
    viewer.zoomTo(tileset);

    // 监听鼠标点击事件
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
    const infoBox = document.getElementById('infoBox');

    handler.setInputAction(function (movement) {

      // 获取点击位置的对象
      const pickedObject = viewer.scene.pick(movement.position);

      if (Cesium.defined(pickedObject)) {
        // 获取点击的经纬度
        const cartesian = viewer.scene.pickPosition(movement.position);

        if (Cesium.defined(cartesian)) {
          const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
          console.log("点击位置:", cartographic);
          const longitude = Cesium.Math.toDegrees(cartographic.longitude).toFixed(15);
          const latitude = Cesium.Math.toDegrees(cartographic.latitude).toFixed(15);
          const height = cartographic.height.toFixed(2);

          // 获取建筑物的 URI
          const content = pickedObject.content._resource;
          const uri = content._url || 'Unknown URI';

          // 显示信息

          // 输出信息到控制台
          console.log(`
            点击信息：
            经度: ${longitude}°
            纬度: ${latitude}°
            高度: ${height} 米
            建筑物 URI: ${uri}
          `);
        }
      } else {
        console.log("未点击到建筑物");
        // 如果未点击到建筑物，隐藏信息框
        // infoBox.style.display = 'none';
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    viewer.canvas.addEventListener('click', async (event) => {
      // 清除之前的无人机和射线
      if (droneEntity) {
        viewer.entities.remove(droneEntity);
        droneEntity = null;
      }

      // 清除之前的射线实体
      rayEntities.forEach(entity => {
        viewer.entities.remove(entity);
      });
      rayEntities = [];

      // 获取鼠标在画布中的相对坐标
      const rect = viewer.canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      const clickPosition = new Cesium.Cartesian2(x, y);

      // 检测地形交点
      const cartesian = viewer.scene.pickPosition(clickPosition);
      if (!cartesian) {
        console.log("未拾取到模型或地形");
        return;
      }

      const cartographic_click = Cesium.Cartographic.fromCartesian(cartesian);
      const longitude_click = Cesium.Math.toDegrees(cartographic_click.longitude);
      const latitude_click = Cesium.Math.toDegrees(cartographic_click.latitude);
      const height_click = cartographic_click.height.toFixed(2);

      console.log("点击坐标（经纬度）:", { longitude_click, latitude_click, height_click });


    });
  </script>
</body>

</html>