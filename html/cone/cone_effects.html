<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true
    });

    // åŠ è½½3DTileset
    const tileset = await Cesium.Cesium3DTileset.fromUrl("https://gl.hangzhoudk.com/modelfile/tileset.json", {
      debugShowBoundingVolume: false
    });
    viewer.scene.primitives.add(tileset);
    viewer.zoomTo(tileset);

    // ======================
    // ğŸš€ æ¨¡æ‹Ÿé£è¡Œè·¯å¾„
    // ======================
    const pathPositions = [
      Cesium.Cartesian3.fromDegrees(116.391, 39.907, 200),
      Cesium.Cartesian3.fromDegrees(116.392, 39.907, 220),
      Cesium.Cartesian3.fromDegrees(116.393, 39.908, 250),
      Cesium.Cartesian3.fromDegrees(116.394, 39.909, 220),
      Cesium.Cartesian3.fromDegrees(116.395, 39.910, 200)
    ];

    const start = Cesium.JulianDate.now();
    const positionProperty = new Cesium.SampledPositionProperty();
    for (let i = 0; i < pathPositions.length; i++) {
      const time = Cesium.JulianDate.addSeconds(start, i * 3, new Cesium.JulianDate());
      positionProperty.addSample(time, pathPositions[i]);
    }

    // âœ… è‡ªåŠ¨è®¡ç®—æœå‘
    const orientationProperty = new Cesium.VelocityOrientationProperty(positionProperty);

    // ======================
    // ğŸ›¸ åˆ›å»ºæ— äººæœºå®ä½“
    // ======================
    const droneEntity = viewer.entities.add({
      name: "æ— äººæœº",
      position: positionProperty,
      orientation: orientationProperty,
      model: {
        uri: "./models/drone_costum.glb",
        scale: 2
      }
    });

    // ======================
    // ğŸ”º é”¥è§†è§†é‡å¯è§†åŒ–ï¼ˆç»ˆæä¿®å¤ï¼šé”¥ä½“å°–ç«¯åœ¨æ— äººæœºä½ç½®ï¼Œå‘å‰å»¶ä¼¸ï¼‰
    // ======================
    const coneLength = 100.0;
    const coneFov = Cesium.Math.toRadians(30);
    const coneRadius = coneLength * Math.tan(coneFov);

    // âœ… å…³é”®ï¼šè®©åœ†æŸ±ä½“æ²¿ X è½´å»¶ä¼¸ï¼ˆæ— äººæœºå‰å‘ï¼‰ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ Z è½´
    const rotationQuaternion = Cesium.Quaternion.fromAxisAngle(Cesium.Cartesian3.UNIT_Y, -Cesium.Math.PI_OVER_TWO);

    const coneEntity = viewer.entities.add({
      name: "æ— äººæœºè§†é‡é”¥",
      position: new Cesium.CallbackProperty(() => {
        const dronePos = droneEntity.position.getValue(viewer.clock.currentTime);
        const droneOri = droneEntity.orientation.getValue(viewer.clock.currentTime);
        
        // è®¡ç®—æ— äººæœºå‰å‘å•ä½å‘é‡ï¼ˆXè½´æ–¹å‘ï¼‰
        const forwardVector = new Cesium.Cartesian3(1, 0, 0);
        const rotatedForward = Cesium.Matrix3.multiplyByVector(
          Cesium.Matrix3.fromQuaternion(droneOri), 
          forwardVector, 
          new Cesium.Cartesian3()
        );
        
        // å°†é”¥ä½“ä½ç½®è®¾åœ¨æ— äººæœºå‰æ–¹ä¸€ä¸ªé•¿åº¦å¤„
        // è¿™æ ·é”¥ä½“ä»è¯¥ä½ç½®å‘åå»¶ä¼¸ï¼Œå°–ç«¯æ­£å¥½è½åœ¨æ— äººæœºä½ç½®
        const conePos = Cesium.Cartesian3.add(
          dronePos, 
          Cesium.Cartesian3.multiplyByScalar(rotatedForward, coneLength/2, new Cesium.Cartesian3()), 
          new Cesium.Cartesian3()
        );
        
        return conePos;
      }, false),
      orientation: new Cesium.CallbackProperty(() => {
        const ori = droneEntity.orientation.getValue(viewer.clock.currentTime);
        // å°† Cylinder çš„ Z è½´æ—‹è½¬åˆ° X è½´ï¼ˆå³å‘å‰ï¼‰â†’ å†ä¹˜ä»¥æ— äººæœºæœå‘
        return Cesium.Quaternion.multiply(ori, rotationQuaternion, new Cesium.Quaternion());
      }, false),
      cylinder: {
        length: coneLength,
        topRadius: 0.0,     // å°–ç«¯åŠå¾„ä¸º0
        bottomRadius: coneRadius, // åº•éƒ¨åŠå¾„
        material: Cesium.Color.YELLOW.withAlpha(0.3),
        outline: true,
        outlineColor: Cesium.Color.ORANGE
      }
    });

    // ======================
    // â±ï¸ è®¾ç½®æ—¶é’Ÿä¸ç›¸æœºè·Ÿéš
    // ======================
    viewer.clock.startTime = start.clone();
    viewer.clock.stopTime = Cesium.JulianDate.addSeconds(start, (pathPositions.length - 1) * 3, new Cesium.JulianDate());
    viewer.clock.currentTime = start.clone();
    viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
    viewer.clock.multiplier = 1.0;
    viewer.trackedEntity = droneEntity;
    
    viewer.clock.shouldAnimate = true; // âœ… å¯åŠ¨åŠ¨ç”»
  </script>
</body>

</html>