<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cesium ä¸‹é›¨æ•ˆæœ</title>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>

  <script type="module">
    // è®¾ç½®ä½ çš„ Access Token
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    // å…ˆåˆ›å»ºåœ°å½¢æä¾›è€…
    const terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(1, {
      requestVertexNormals: true,
      requestWaterMask: true
    });

    // åˆ›å»º Viewer
    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true,
      terrainProvider: terrainProvider
    });

    // åŠ è½½ 3D Tileset
    const tileset = await Cesium.Cesium3DTileset.fromUrl("http://192.168.4.78:8000/tileset.json");
    viewer.scene.primitives.add(tileset);
    await viewer.zoomTo(tileset);

    // ======================
    // âœ… åˆ›å»ºä¸‹é›¨ç²’å­ç³»ç»Ÿ
    // ======================

    const rainParticleSystem = new Cesium.ParticleSystem({
      // ä½¿ç”¨ Base64 å†…è”ç™½ç‚¹
      image: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=',

      // ç”¨äº®è‰²æµ‹è¯•ï¼ˆé’è‰²ï¼‰ï¼Œç¡®ä¿ä½ èƒ½çœ‹åˆ°
      startColor: Cesium.Color.RED.withAlpha(1.0),
      endColor: Cesium.Color.RED.withAlpha(1.0),

      // ç”Ÿå‘½ä¸é€Ÿåº¦
      particleLife: 2.0,
      speed: 60.0,

      // é›¨æ»´å½¢çŠ¶ï¼šç»†é•¿
      imageSize: new Cesium.Cartesian2(20, 20),


      // å‘å°„å¯†åº¦
      emissionRate: 4000,  // æ¯ç§’å‘å°„ 4000 ä¸ªç²’å­

      // ç³»ç»Ÿç”Ÿå‘½å‘¨æœŸï¼ˆå¯å¿½ç•¥ï¼‰
      lifetime: 3600,

      // å‘å°„å™¨ï¼šä»¥ç›¸æœºä¸ºä¸­å¿ƒï¼ŒåŠå¾„ 300 ç±³çš„çƒ
      emitter: new Cesium.SphereEmitter(300.0),

      // â—å…³é”®ï¼šå…ˆä¸è®¾ modelMatrixï¼Œåé¢æ¯å¸§æ›´æ–°

      // æ›´æ–°å›è°ƒï¼šæ·»åŠ é‡åŠ›ï¼ˆå‘ä¸‹åŠ é€Ÿï¼‰
      updateCallback: (particle, dt) => {
        // Z è½´è´Ÿæ–¹å‘ä¸ºâ€œå‘ä¸‹â€ï¼ˆåœ¨ ENU å±€éƒ¨åæ ‡ä¸­ï¼‰
        Cesium.Cartesian3.add(
          particle.velocity,
          new Cesium.Cartesian3(0, 0, -35), // é‡åŠ›åŠ é€Ÿåº¦
          particle.velocity
        );
      },

      // å¯ç”¨æ·±åº¦æµ‹è¯•ï¼ˆé˜²æ­¢ç©¿æ¨¡ï¼‰
      depthTest: true
    });

    // æ·»åŠ åˆ°åœºæ™¯
    window.rainSystem = viewer.scene.primitives.add(rainParticleSystem);

    // ======================
    // âœ… æ¯å¸§æ›´æ–°ï¼šè®©é›¨è·Ÿéšç›¸æœºï¼Œå¹¶æ­£ç¡®å¯¹é½æ–¹å‘
    // ======================
    viewer.scene.postUpdate.addEventListener(() => {
      const position = viewer.scene.camera.position;

      // âœ… æ­£ç¡®åˆ›å»º ENU å±€éƒ¨åæ ‡ç³»çŸ©é˜µ
      const enuToFixed = Cesium.Transforms.eastNorthUpToFixedFrame(position);

      // åº”ç”¨åˆ°ç²’å­ç³»ç»Ÿ
      window.rainSystem.modelMatrix = enuToFixed;
    });

    console.log("ğŸŒ§ï¸ ä¸‹é›¨æ•ˆæœå·²å¯åŠ¨ï¼è¯·æŠ¬å¤´çœ‹å¤©ç©ºï¼Œæˆ–é£åˆ°é«˜ç©ºè§‚å¯Ÿã€‚");
    console.log("å¦‚æœçœ‹ä¸åˆ°ï¼Œè¯·å°è¯•ï¼š");
    console.log("1. æŒ‰ä½ Ctrl + é¼ æ ‡å·¦é”® å‘ä¸Šä»°å¤´");
    console.log("2. é£åˆ°å»ºç­‘ä¸Šæ–¹ï¼ˆZ è½´æ›´é«˜ï¼‰");
    console.log("3. æŠŠ startColor æ”¹æˆ Color.RED æµ‹è¯•");
  </script>
</body>

</html>