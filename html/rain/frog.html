<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Cesium Global Fog Effect - Simple Version</title>
    <script src="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Cesium.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
    <style>
        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>
    <script type="module">
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

        (async () => {
            try {
                const viewer = new Cesium.Viewer("cesiumContainer", {
                    terrainProvider: await Cesium.CesiumTerrainProvider.fromIonAssetId(1, {
                        requestVertexNormals: true,
                        requestWaterMask: true
                    })
                });

                // === ç®€åŒ–æ–¹æ¡ˆï¼šä¸»è¦ä½¿ç”¨å†…ç½®é›¾æ•ˆ + Tileseté›¾æ•ˆ ===

                // ä¸å†ä½¿ç”¨åœ°å½¢æè´¨é›¾æ•ˆï¼Œæ”¹ä¸ºä½¿ç”¨æ›´å¼ºçš„å†…ç½®é›¾æ•ˆ
                viewer.scene.fog.enabled = true;
                viewer.scene.fog.density = 0.0003; // å¢åŠ å¯†åº¦
                viewer.scene.fog.screenSpaceErrorFactor = 3.0;
                viewer.scene.fog.minimumBrightness = 0.1;

                // === æ–¹æ³•2: ä¸ºåœ°å½¢æ·»åŠ é›¾æ•ˆæè´¨ ===
                const createFogMaterial = (fogColor, fogDensity) => {
                    return new Cesium.Material({
                        fabric: {
                            type: 'FogGlobe',
                            uniforms: {
                                fogColor: fogColor,
                                fogDensity: fogDensity
                            },
                            source: `
                                czm_material czm_getMaterial(czm_materialInput materialInput) {
                                    czm_material material = czm_getDefaultMaterial(materialInput);
                                    
                                    // ä½¿ç”¨é»˜è®¤åœ°å½¢é¢œè‰²ï¼ˆè®©Cesiumå¤„ç†åœ°å½¢çº¹ç†ï¼‰
                                    // material.diffuse å·²ç»åŒ…å«äº†åœ°å½¢çš„çœŸå®é¢œè‰²
                                    
                                    // è®¡ç®—åˆ°æ‘„åƒæœºçš„è·ç¦»
                                    float distance = length(materialInput.positionToEyeEC);
                                    
                                    // è®¡ç®—é›¾æ•ˆå› å­
                                    float fogFactor = 1.0 - exp(-distance * fogDensity);
                                    fogFactor = clamp(fogFactor, 0.0, 0.6); // é™åˆ¶æœ€å¤§é›¾æ•ˆå¼ºåº¦
                                    
                                    // ä¿æŒåŸå§‹åœ°å½¢é¢œè‰²ï¼Œåªåœ¨è¿œå¤„æ·»åŠ é›¾æ•ˆ
                                    material.diffuse = mix(material.diffuse, fogColor, fogFactor);
                                    material.alpha = 1.0;
                                    
                                    return material;
                                }
                            `
                        }
                    });
                };

                let terrainFogMaterial = createFogMaterial(
                    new Cesium.Cartesian3(0.8, 0.9, 1.0),
                    0.00001
                );

                // === æ–¹æ³•3: ä¸º 3D Tileset æ·»åŠ é›¾æ•ˆ ===
                const tilesetFogShader = new Cesium.CustomShader({
                    fragmentShaderText: `
                        void fragmentMain(FragmentInput fsInput, inout czm_modelMaterial material) {
                            // è®¡ç®—è·ç¦»é›¾æ•ˆ
                            float viewDistance = length(fsInput.attributes.positionEC);
                            float fogFactor = 1.0 - exp(-viewDistance * fogDensity);
                            fogFactor = clamp(fogFactor, 0.0, 0.8);
                            
                            // åº”ç”¨é›¾æ•ˆåˆ°æè´¨é¢œè‰²
                            vec3 finalColor = mix(material.diffuse, fogColor, fogFactor);
                            material.diffuse = finalColor;
                        }
                    `,
                    uniforms: {
                        fogDensity: {
                            type: Cesium.UniformType.FLOAT,
                            value: 0.00001
                        },
                        fogColor: {
                            type: Cesium.UniformType.VEC3,
                            value: new Cesium.Cartesian3(0.8, 0.9, 1.0)
                        }
                    }
                });

                // åŠ è½½ 3D Tiles å¹¶åº”ç”¨é›¾æ•ˆ
                try {
                    const tileset = await Cesium.Cesium3DTileset.fromUrl("http://192.168.4.78:8000/tileset.json");
                    tileset.customShader = tilesetFogShader;
                    viewer.scene.primitives.add(tileset);
                    viewer.zoomTo(tileset);
                } catch (error) {
                    console.warn("æ— æ³•åŠ è½½ 3D Tileset:", error);
                }

                // ç§»é™¤åœ°å½¢é›¾æ•ˆæè´¨çš„åº”ç”¨
                // viewer.scene.globe.material = terrainFogMaterial;

                // === æ–¹æ³•4: å¤§æ°”æ•ˆæœå¢å¼º ===
                viewer.scene.skyAtmosphere.show = true;
                viewer.scene.skyAtmosphere.brightnessShift = 0.1;
                viewer.scene.skyAtmosphere.saturationShift = -0.2;

                // è®¾ç½®å…¨å±€å…‰ç…§
                viewer.scene.light = new Cesium.DirectionalLight({
                    direction: new Cesium.Cartesian3(-1, -1, -1),
                    color: new Cesium.Color(1.0, 0.95, 0.8, 1.0),
                    intensity: 2.0
                });

                // === æ§åˆ¶é¢æ¿ ===
                const toolbar = document.createElement('div');
                toolbar.style.cssText = `
                    position: absolute;
                    top: 10px;
                    left: 10px;
                    background: rgba(42, 42, 42, 0.9);
                    padding: 15px;
                    border-radius: 8px;
                    color: white;
                    font-family: Arial, sans-serif;
                    font-size: 12px;
                    min-width: 280px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                `;

                toolbar.innerHTML = `
                    <h4 style="margin-top: 0; color: #fff;">ğŸŒ«ï¸ å…¨å±€é›¾æ•ˆæ§åˆ¶</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <h5 style="margin: 10px 0 5px 0; color: #ccc;">å†…ç½®é›¾æ•ˆ</h5>
                        <label><input type="checkbox" id="enableBuiltinFog" checked> å¯ç”¨å†…ç½®é›¾æ•ˆ</label><br>
                        <label>å†…ç½®é›¾å¯†åº¦: <input type="range" id="builtinFogDensity" min="0" max="0.002" step="0.0001" value="0.0003"></label><br>
                        <label>æœ€å°äº®åº¦: <input type="range" id="fogMinBrightness" min="0" max="1" step="0.1" value="0.1"></label><br>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h5 style="margin: 10px 0 5px 0; color: #ccc;">è‡ªå®šä¹‰é›¾æ•ˆ</h5>
                        <label>é›¾å¯†åº¦: <input type="range" id="customFogDensity" min="0" max="0.0001" step="0.000001" value="0.00001"></label><br>
                        <label>é›¾é¢œè‰² R: <input type="range" id="fogColorR" min="0" max="1" step="0.1" value="0.8"></label><br>
                        <label>é›¾é¢œè‰² G: <input type="range" id="fogColorG" min="0" max="1" step="0.1" value="0.9"></label><br>
                        <label>é›¾é¢œè‰² B: <input type="range" id="fogColorB" min="0" max="1" step="0.1" value="1.0"></label><br>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h5 style="margin: 10px 0 5px 0; color: #ccc;">å¼€å…³æ§åˆ¶</h5>
                        <label><input type="checkbox" id="enableAtmosphere" checked> å¯ç”¨å¤§æ°”æ•ˆæœ</label><br>
                        <label><input type="checkbox" id="enableAdvancedFog" checked> å¯ç”¨é«˜çº§é›¾æ•ˆ</label><br>
                    </div>
                    
                    <div>
                        <button id="resetFog" style="background: #48a; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">é‡ç½®é›¾æ•ˆ</button>
                        <button id="presetLight" style="background: #a84; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-left: 5px;">è½»é›¾</button>
                        <button id="presetHeavy" style="background: #666; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-left: 5px;">æµ“é›¾</button>
                    </div>
                `;

                document.body.appendChild(toolbar);

                // === äº‹ä»¶ç›‘å¬å™¨ ===
                function updateCustomFogParameters() {
                    const density = parseFloat(document.getElementById('customFogDensity').value);
                    const colorR = parseFloat(document.getElementById('fogColorR').value);
                    const colorG = parseFloat(document.getElementById('fogColorG').value);
                    const colorB = parseFloat(document.getElementById('fogColorB').value);
                    const fogColor = new Cesium.Cartesian3(colorR, colorG, colorB);

                    // æ›´æ–° tileset é›¾æ•ˆ
                    if (tilesetFogShader && document.getElementById('enableAdvancedFog').checked) {
                        tilesetFogShader.setUniform('fogDensity', density);
                        tilesetFogShader.setUniform('fogColor', fogColor);
                    }
                }

                // è‡ªå®šä¹‰é›¾æ•ˆå‚æ•°æ§åˆ¶
                document.getElementById('customFogDensity').addEventListener('input', updateCustomFogParameters);
                document.getElementById('fogColorR').addEventListener('input', updateCustomFogParameters);
                document.getElementById('fogColorG').addEventListener('input', updateCustomFogParameters);
                document.getElementById('fogColorB').addEventListener('input', updateCustomFogParameters);

                // å†…ç½®é›¾æ•ˆæ§åˆ¶
                document.getElementById('enableBuiltinFog').addEventListener('change', (e) => {
                    viewer.scene.fog.enabled = e.target.checked;
                });

                document.getElementById('builtinFogDensity').addEventListener('input', (e) => {
                    viewer.scene.fog.density = parseFloat(e.target.value);
                });

                document.getElementById('fogMinBrightness').addEventListener('input', (e) => {
                    viewer.scene.fog.minimumBrightness = parseFloat(e.target.value);
                });

                // é«˜çº§é›¾æ•ˆå¼€å…³ï¼ˆæ§åˆ¶Tileseté›¾æ•ˆï¼‰
                document.getElementById('enableAdvancedFog').addEventListener('change', (e) => {
                    if (e.target.checked && tilesetFogShader) {
                        // é‡æ–°åº”ç”¨è‡ªå®šä¹‰é›¾æ•ˆ
                        updateCustomFogParameters();
                    } else if (tilesetFogShader) {
                        // ç¦ç”¨è‡ªå®šä¹‰é›¾æ•ˆ
                        tilesetFogShader.setUniform('fogDensity', 0.0);
                    }
                });

                // å¤§æ°”æ•ˆæœå¼€å…³
                document.getElementById('enableAtmosphere').addEventListener('change', (e) => {
                    viewer.scene.skyAtmosphere.show = e.target.checked;
                });

                // é‡ç½®æŒ‰é’®
                document.getElementById('resetFog').addEventListener('click', () => {
                    document.getElementById('customFogDensity').value = 0.00001;
                    document.getElementById('fogColorR').value = 0.8;
                    document.getElementById('fogColorG').value = 0.9;
                    document.getElementById('fogColorB').value = 1.0;
                    document.getElementById('builtinFogDensity').value = 0.0003;
                    document.getElementById('fogMinBrightness').value = 0.1;
                    document.getElementById('enableBuiltinFog').checked = true;
                    document.getElementById('enableAdvancedFog').checked = true;
                    document.getElementById('enableAtmosphere').checked = true;

                    viewer.scene.fog.enabled = true;
                    viewer.scene.fog.density = 0.0003;
                    viewer.scene.fog.minimumBrightness = 0.1;
                    viewer.scene.skyAtmosphere.show = true;
                    updateCustomFogParameters();
                });

                // é¢„è®¾æŒ‰é’®
                document.getElementById('presetLight').addEventListener('click', () => {
                    document.getElementById('customFogDensity').value = 0.000005;
                    document.getElementById('builtinFogDensity').value = 0.0001;
                    document.getElementById('fogColorR').value = 0.9;
                    document.getElementById('fogColorG').value = 0.95;
                    document.getElementById('fogColorB').value = 1.0;
                    viewer.scene.fog.density = 0.0001;
                    updateCustomFogParameters();
                });

                document.getElementById('presetHeavy').addEventListener('click', () => {
                    document.getElementById('customFogDensity').value = 0.00005;
                    document.getElementById('builtinFogDensity').value = 0.0005;
                    document.getElementById('fogColorR').value = 0.7;
                    document.getElementById('fogColorG').value = 0.8;
                    document.getElementById('fogColorB').value = 0.9;
                    viewer.scene.fog.density = 0.0005;
                    updateCustomFogParameters();
                });

                console.log("å…¨å±€é›¾æ•ˆåˆå§‹åŒ–å®Œæˆ âœ“");
                console.log("- å†…ç½®é›¾æ•ˆ: å¯ç”¨ï¼ˆä¸»è¦é›¾æ•ˆï¼‰");
                console.log("- 3D Tileset é›¾æ•ˆ: å¯ç”¨ï¼ˆå»ºç­‘é›¾æ•ˆï¼‰");
                console.log("- å¤§æ°”æ•ˆæœ: å¢å¼º");
                console.log("- åœ°å½¢ä¿æŒåŸå§‹é¢œè‰²");

            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", error);
            }
        })();
    </script>
</body>

</html>