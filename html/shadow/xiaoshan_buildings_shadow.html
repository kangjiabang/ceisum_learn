<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    // Your access token can be found at: https://ion.cesium.com/tokens.    
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    // å…ˆåˆ›å»ºåœ°å½¢æä¾›è€…
    const terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(1, {
      requestVertexNormals: true,
      requestWaterMask: true
    });

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true,
      terrainProvider: terrainProvider
    });

    // å­˜å‚¨åˆ›å»ºçš„å®ä½“
    let droneEntity = null;
    let rayEntities = [];
    let buildingEntity = null; // å­˜å‚¨å»ºç­‘ç‰©å®ä½“

    //åŠ è½½ 3D Tilesetï¼ˆè‡ªåŠ¨è§£æ B3DMï¼‰
    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl(
        "http://192.168.4.78:8000/tileset.json",
        {
          debugShowBoundingVolume: true,
        })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      //console.log(`æ­£åœ¨åŠ è½½: ${numberOfPendingRequests} ä¸ªè¯·æ±‚`);
    });

    // å®šä½åˆ° Tileset
    viewer.zoomTo(tileset);

    viewer.canvas.addEventListener('click', async (event) => {
      try {
        // æ¸…é™¤ä¹‹å‰çš„æ— äººæœºå’Œå°„çº¿
        if (droneEntity) {
          viewer.entities.remove(droneEntity);
          droneEntity = null;
        }

        // æ¸…é™¤ä¹‹å‰çš„å°„çº¿å®ä½“
        rayEntities.forEach(entity => {
          viewer.entities.remove(entity);
        });
        rayEntities = [];

        // æ¸…é™¤ä¹‹å‰çš„å»ºç­‘ç‰©å®ä½“
        if (buildingEntity) {
          viewer.entities.remove(buildingEntity);
          buildingEntity = null;
        }


        // ä½¿ç”¨å›ºå®šçš„å»ºç­‘ç‰©ä¸­å¿ƒç‚¹åæ ‡ (ç”¨äºæ— äººæœº)
        // æ³¨æ„ï¼šè¿™å’Œä½ è¦åˆ›å»ºçš„å»ºç­‘ç‰©åæ ‡ä¸åŒ
        const longitude_click = 119.993779;
        const latitude_click = 30.283050;
        const height_click = 300;

        console.log("ç‚¹å‡»åæ ‡ï¼ˆç”¨äºæ— äººæœºï¼‰:", { longitude_click, latitude_click, height_click });

        // --- åˆ›å»ºå»ºç­‘ç‰©å®ä½“ ---
        // ä½ çš„å»ºç­‘ç‰© MULTIPOLYGON æ•°æ®
        const polygonWkt = "MULTIPOLYGON(((119.9934527 30.2831678,119.9939089 30.2832781,119.9939901 30.2832941,119.9941017 30.2829358,119.9935789 30.2828015,119.9934527 30.2831678)))";
        const buildingHeight = 300.0; // å»ºç­‘ç‰©æœ¬èº«çš„é«˜åº¦ä¸º 20 ç±³

        // --- è§£æ WKT ---
        const match = polygonWkt.match(/\(\(\(([^)]+)\)\)\)/);
        if (!match) {
          throw new Error("æ— æ³•è§£æ MULTIPOLYGON WKT");
        }
        const coordString = match[1];
        const coordPairs = coordString.split(',');

        const coordinates = [];
        for (let i = 0; i < coordPairs.length; i++) {
          const [lon, lat] = coordPairs[i].trim().split(' ').map(Number);
          coordinates.push(lon, lat);
        }

        // --- è®¡ç®—å¤šè¾¹å½¢ä¸­å¿ƒç‚¹ç”¨äºè·å–åœ°å½¢é«˜åº¦ ---
        let lonSum = 0, latSum = 0;
        for (let i = 0; i < coordinates.length; i += 2) {
          lonSum += coordinates[i];
          latSum += coordinates[i + 1];
        }
        const centerLon = lonSum / (coordinates.length / 2);
        const centerLat = latSum / (coordinates.length / 2);
        console.log(`å»ºç­‘ç‰©å¤šè¾¹å½¢ä¸­å¿ƒç‚¹: (${centerLon.toFixed(6)}, ${centerLat.toFixed(6)})`);

        // --- è·å–å»ºç­‘ç‰©ä¸­å¿ƒç‚¹çš„åœ°å½¢é«˜åº¦ ---
        const terrainSample = await Cesium.sampleTerrainMostDetailed(
          viewer.terrainProvider,
          [new Cesium.Cartographic(
            Cesium.Math.toRadians(centerLon),
            Cesium.Math.toRadians(centerLat)
          )]
        );

        const buildingTerrainHeight = terrainSample && terrainSample.length > 0 ? terrainSample[0].height : 0;
        console.log("å»ºç­‘ç‰©åŒºåŸŸåœ°å½¢é«˜åº¦:", buildingTerrainHeight.toFixed(2), "ç±³");


        // --- åŸºäºåœ°å½¢é«˜åº¦è®¾ç½®å»ºç­‘ç‰©çš„åº•éƒ¨å’Œé¡¶éƒ¨ ---
        const bottomHeight = buildingTerrainHeight; // å»ºç­‘ç‰©åº•éƒ¨è´´åœ°
        const topHeight = bottomHeight + buildingHeight; // å»ºç­‘ç‰©é¡¶éƒ¨é«˜åº¦

        console.log(`å»ºç­‘ç‰©é«˜åº¦è®¾ç½®: åº•éƒ¨=${bottomHeight.toFixed(2)}m, é¡¶éƒ¨=${topHeight.toFixed(2)}m`);


        // --- åˆ›å»ºæŒ¤å‡ºçš„å¤šè¾¹å½¢å®ä½“ ---
        buildingEntity = viewer.entities.add({
          name: 'Extruded Building',
          polygon: {
            hierarchy: Cesium.Cartesian3.fromDegreesArray(coordinates),
            extrudedHeight: topHeight,     // é¡¶éƒ¨æµ·æ‹”é«˜åº¦
            height: bottomHeight,          // åº•éƒ¨æµ·æ‹”é«˜åº¦
            material: Cesium.Color.BLUE.withAlpha(0.7), // è“è‰²åŠé€æ˜
            outline: true,
            outlineColor: Cesium.Color.RED,
            outlineWidth: 2,
            // ç¡®ä¿é¡¶éƒ¨å’Œåº•éƒ¨å°é—­
            closeTop: true,
            closeBottom: true
          }
        });
        console.log("âœ… å»ºç­‘ç‰©å®ä½“å·²åˆ›å»º");


        // --- å°†ç›¸æœºç§»åŠ¨åˆ°å»ºç­‘ç‰©é™„è¿‘ ---
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(centerLon, centerLat, topHeight + 100.0), // åœ¨å»ºç­‘ç‰©ä¸Šæ–¹ä¸€ç‚¹
          orientation: {
            heading: Cesium.Math.toRadians(0.0),
            pitch: Cesium.Math.toRadians(-45.0),
            roll: 0.0
          },
          duration: 2.0 // é£è¡Œæ—¶é—´2ç§’
        });
        console.log("ğŸ“· ç›¸æœºæ­£åœ¨é£å¾€å»ºç­‘ç‰©...");



      } catch (error) {
        console.error("å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™:", error);
      }
    });
  </script>
</body>

</html>