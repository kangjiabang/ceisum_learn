<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    // Your access token can be found at: https://ion.cesium.com/tokens.
    // This is the default access token from your ion account

    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true
    });

    // 存储创建的实体
    let droneEntity = null;                                            
    let rayEntities = [];

    //加载 3D Tileset（自动解析 B3DM）
    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl(
        "https://gl.hangzhoudk.com/modelfile/tileset.json",
        {
          debugShowBoundingVolume: false, // 优化动态加载
        })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      console.log(`正在加载: ${numberOfPendingRequests} 个请求`);
    });

    // 定位到 Tileset
    viewer.zoomTo(tileset);

    // 用于存储当前被选中的实体
let selectedEntity = null;
// 用于存储 GeoJSON 数据源
let geoJsonDataSource = null;

// --- 步骤 1: 定义默认和高亮样式 ---

// 默认填充样式
const DEFAULT_FILL_COLOR = Cesium.Color.GREY.withAlpha(0.1);
const DEFAULT_OUTLINE_COLOR = Cesium.Color.WHITE;
const DEFAULT_OUTLINE_WIDTH = 1;

// 选中后的高亮样式
const HIGHLIGHT_FILL_COLOR = Cesium.Color.YELLOW.withAlpha(0.4);
const HIGHLIGHT_OUTLINE_COLOR = Cesium.Color.RED;
const HIGHLIGHT_OUTLINE_WIDTH = 10;


// --- 步骤 2: 加载 GeoJSON 数据 ---

async function loadGeoJsonAndSetInitialStyles(url) {
    try {
        geoJsonDataSource = new Cesium.GeoJsonDataSource();
        
        await geoJsonDataSource.load(url, {
            // 默认样式将在这里被初始化，但会被下面的 CallbackProperty 覆盖，所以这里可以简化或保留。
            // 为了清晰，我们直接在实体上设置动态样式。
            clampToGround: true, // 确保多边形贴合地面,添加这个后，边框不显示
        });

        const entities = geoJsonDataSource.entities.values;
       entities.forEach(entity => {
            if (entity.polygon) {

                // === 计算区域中心点 ===
                const hierarchy = entity.polygon.hierarchy.getValue();
                const positions = hierarchy.positions || hierarchy; // 兼容不同 Cesium 版本
                const center = Cesium.BoundingSphere.fromPoints(positions).center;

                // === 添加 Label（区域名称）===
                entity.position = center;
                entity.label = new Cesium.LabelGraphics({
                    text: entity.name || "未命名区域",
                    font: "16px sans-serif",
                    fillColor: Cesium.Color.BLACK,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2,
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    pixelOffset: new Cesium.Cartesian2(0, -10)
                });

                // === 原有 polygon 动态高亮 ===
                entity.polygon.outline = true;
                entity.polygon.material = new Cesium.ColorMaterialProperty(
                    new Cesium.CallbackProperty(() => {
                        return entity === selectedEntity ? HIGHLIGHT_FILL_COLOR : DEFAULT_FILL_COLOR;
                    }, false)
                );
                entity.polygon.outlineColor = new Cesium.CallbackProperty(() => {
                    return entity === selectedEntity ? HIGHLIGHT_OUTLINE_COLOR : DEFAULT_OUTLINE_COLOR;
                }, false);
                entity.polygon.outlineWidth = new Cesium.CallbackProperty(() => {
                    return entity === selectedEntity ? HIGHLIGHT_OUTLINE_WIDTH : DEFAULT_OUTLINE_WIDTH;
                }, false);
            }
        });

        viewer.dataSources.add(geoJsonDataSource);
        //viewer.flyTo(geoJsonDataSource);
        console.log('GeoJSON 数据加载完成。');

    } catch (error) {
        console.error('加载或处理 GeoJSON 数据失败:', error);
    }
}
// 替换为您的 GeoJSON 文件路径
loadGeoJsonAndSetInitialStyles('./330100.geojson');


// --- 步骤 3: 实现区域选中（拾取和高亮） ---

const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

// 监听鼠标左键点击事件
handler.setInputAction(function (movement) {
    const pickedObject = viewer.scene.pick(movement.position);
    let newSelectedEntity = null;

    if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id)) {
        if (geoJsonDataSource.entities.contains(pickedObject.id)) {
            newSelectedEntity = pickedObject.id;
        }
    }

    // 【关键修改】如果点击的是当前已选中的实体，则取消选中
    if (newSelectedEntity === selectedEntity) {
        selectedEntity = null; // 取消高亮
        console.log('取消选中区域。');
    } else {
        selectedEntity = newSelectedEntity; // 切换到新选中区域
        if (selectedEntity) {
            const name = selectedEntity._name || '未命名区域';
            console.log(`选中区域: ${name}`);
        } else {
            console.log('未选中任何 GeoJSON 区域。');
        }
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);
  </script>
</body>

</html>