<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true
    });

    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl(
        "http://localhost:5173/assets/xiaoshan_3dtiles/tileset.json",
        {
          debugShowBoundingVolume: true,
        })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      console.log(`æ­£åœ¨åŠ è½½: ${numberOfPendingRequests} ä¸ªè¯·æ±‚`);
    });

    viewer.zoomTo(tileset);

    viewer.canvas.addEventListener('click', async (event) => {
      const rect = viewer.canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      const clickPosition = new Cesium.Cartesian2(x, y);
      const ray_click = viewer.camera.getPickRay(clickPosition);

      if (!ray_click) {
        console.log("æ— æ³•ç”Ÿæˆå°„çº¿");
        return;
      }

      const cartesian = viewer.scene.globe.pick(ray_click, viewer.scene);
      if (!cartesian) {
        console.log("æœªç‚¹å‡»åˆ°åœ°å½¢");
        return;
      }

      const cartographic_click = Cesium.Cartographic.fromCartesian(cartesian);
      const longitude_click = Cesium.Math.toDegrees(cartographic_click.longitude);
      const latitude_click = Cesium.Math.toDegrees(cartographic_click.latitude);
      const height_click = cartographic_click.height + 100.0;

      console.log("ç‚¹å‡»åæ ‡ï¼ˆç»çº¬åº¦ï¼‰:", { longitude_click, latitude_click, height_click });

      const dronePositionCartesian = Cesium.Cartesian3.fromDegrees(
        longitude_click,
        latitude_click,
        height_click
      );

      const airplaneUri = await Cesium.IonResource.fromAssetId(3472138);

      const heading = Cesium.Math.toRadians(-90);
      const pitch = Cesium.Math.toRadians(0);
      const roll = Cesium.Math.toRadians(0);

      const hpr = new Cesium.HeadingPitchRoll(heading, pitch, roll);
      const orientation = Cesium.Transforms.headingPitchRollQuaternion(
        dronePositionCartesian,
        hpr
      );

      const droneEntity = viewer.entities.add({
        name: "æ— äººæœº",
        position: dronePositionCartesian,
        orientation: orientation,
        model: {
          uri: airplaneUri,
          scale: 5.0,
          minimumPixelSize: 64
        }
      });

      viewer.zoomTo(droneEntity);

      // -----------------------------
      // âœ… çƒä½“ç¢°æ’žæ£€æµ‹æ›¿æ¢å¼€å§‹
      // -----------------------------

      const droneBoundingSphere = new Cesium.BoundingSphere(dronePositionCartesian, 50); // 10ç±³åŠå¾„
      let hitCount = 0;

      // éåŽ† tileset çš„æ‰€æœ‰å¯è§ tile
      tileset.tileVisible.addEventListener((tile) => {
        const content = tile.content;
        for (let i = 0; i < content.featuresLength; i++) {
          const feature = content.getFeature(i);

          const featureSphere = feature.boundingSphere;
          const distance = Cesium.Cartesian3.distance(
            droneBoundingSphere.center,
            featureSphere.center
          );

          const radiusSum = droneBoundingSphere.radius + featureSphere.radius;
          console.log(`æ£€æµ‹ feature ${i}ï¼šè·ç¦» ${distance.toFixed(2)}m, åŠå¾„å’Œ ${radiusSum.toFixed(2)}m`);

          if (distance < radiusSum) {
            console.log(`ðŸŽ¯ ç¢°æ’žï¼šfeature è·ç¦» ${distance.toFixed(2)}m`);
            feature.color = Cesium.Color.BLUE.withAlpha(0.5);

            viewer.entities.add({
              position: featureSphere.center,
              point: {
                pixelSize: 15,
                color: Cesium.Color.RED
              }
            });

            hitCount++;
          }
        }
      });

      if (hitCount === 0) {
        console.log("âœ… æ²¡æœ‰æ£€æµ‹åˆ°ç¢°æ’ž");
      } else {
        console.log(`âœ… æ€»å…±æ£€æµ‹åˆ° ${hitCount} ä¸ªç¢°æ’žå¯¹è±¡`);
      }

      // -----------------------------
      // âœ… çƒä½“ç¢°æ’žæ£€æµ‹æ›¿æ¢ç»“æŸ
      // -----------------------------
    });
  </script>
</body>

</html>