<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    // Your access token can be found at: https://ion.cesium.com/tokens.
    // This is the default access token from your ion account

    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true
    });

    // currentTileset = viewer.scene.primitives.add(
    //   await Cesium.Cesium3DTileset.fromUrl(
    //     `http://localhost:5173/assets/0_0_0-2_1_1/tileset.json`,
    //     {
    //       debugShowBoundingVolume: true,
    //     }
    //   )
    // );

    //åŠ è½½ 3D Tilesetï¼ˆè‡ªåŠ¨è§£æ B3DMï¼‰
    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl(
        "http://localhost:5173/assets/xiaoshan_3dtiles/tileset.json",
        {
          debugShowBoundingVolume: true, // ä¼˜åŒ–åŠ¨æ€åŠ è½½
        })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      console.log(`æ­£åœ¨åŠ è½½: ${numberOfPendingRequests} ä¸ªè¯·æ±‚`);
    });

    // å®šä½åˆ° Tileset
    viewer.zoomTo(tileset);


    //æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    viewer.canvas.addEventListener('click', async (event) => {

      const width = viewer.canvas.clientWidth;
      const height = viewer.canvas.clientHeight;

      if (!width || !height) {
        console.error("âŒ canvas å°ºå¯¸å¼‚å¸¸", { width, height });
        return;
      }
      // è·å–é¼ æ ‡ç‚¹å‡»çš„çª—å£åæ ‡ï¼ˆç›¸å¯¹äº canvas çš„ x, yï¼‰
      const rect = viewer.canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      console.log("ç‚¹å‡»åæ ‡:", { x, y });
      // è·å–ç›¸æœºæ–¹å‘
      const ray = viewer.camera.getPickRay(new Cesium.Cartesian2(x, y));
      if (!ray) {
        console.log("âš ï¸ æ— æ³•ç”Ÿæˆå°„çº¿");
        return;
      }

      const intersection = viewer.scene.pickFromRay(ray);

      if (intersection && intersection.position) {
        const hitPoint = intersection.position;
        const cartographic = Cesium.Cartographic.fromCartesian(hitPoint);

        const lon = Cesium.Math.toDegrees(cartographic.longitude);
        const lat = Cesium.Math.toDegrees(cartographic.latitude);
        const height = cartographic.height;

        console.log("âœ… å‘½ä¸­æ¨¡å‹ï¼");
        console.log(`ä¸–ç•Œåæ ‡:`, hitPoint);
        console.log(`åœ°ç†åæ ‡: ç»åº¦=${lon.toFixed(6)}, çº¬åº¦=${lat.toFixed(6)}, é«˜åº¦=${height.toFixed(2)} ç±³`);

        // è®¡ç®—è·ç¦»ï¼šç›¸æœºä½ç½® vs ç¢°æ’ç‚¹
        const cameraPosition = viewer.camera.positionWC;
        const distance = Cesium.Cartesian3.distance(cameraPosition, hitPoint);
        console.log(`ğŸ“ ç›¸æœºåˆ°å‘½ä¸­ç‚¹çš„è·ç¦»: ${distance.toFixed(2)} ç±³`);

        // å¯è§†åŒ–å‘½ä¸­ç‚¹
        viewer.entities.add({
          position: hitPoint,
          point: {
            pixelSize: 10,
            color: Cesium.Color.RED
          }
        });
      } else {
        console.log("âŒ æœªå‘½ä¸­ä»»ä½•ç‰©ä½“");
      }
    });
  </script>
</body>

</html>