<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    #cesiumContainer {
      width: 100%;
      height: 100vh;
      margin: 0;
      padding: 0;
      display: block;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
   
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

        const viewer = new Cesium.Viewer("cesiumContainer", {
            shouldDebug: true
        });

        // åŠ è½½ 3D Tileset
        const tileset = viewer.scene.primitives.add(
            await Cesium.Cesium3DTileset.fromUrl(
                "https://gl.hangzhoudk.com/modelfile/tileset.json", {
                    debugShowBoundingVolume: false,
                })
        );
        
        // ----------------------------------------------------
        // ğŸ’¡ 1. å®šä¹‰è¦è£å‰ªçš„åœ°ç†åŒºåŸŸï¼ˆç»çº¬åº¦èŒƒå›´ï¼‰
        // ----------------------------------------------------
        const minLon = 119.9384401375432;
        const maxLon = 120.03013724921674;
        const minLat = 30.261852568883025;
        const maxLat = 30.31701791606819;
        const maxAltitude = 200.0; // è£å‰ªçš„æœ€å¤§é«˜åº¦ï¼ˆç±³ï¼‰



        // ----------------------------------------------------
        // ğŸ’¡ 2. è®¡ç®—ä¸­å¿ƒç‚¹å’Œè£å‰ªå¹³é¢çš„æœ¬åœ°åæ ‡ç³»
        // ----------------------------------------------------
        const centerLon = (minLon + maxLon) / 2.0;
        const centerLat = (minLat + maxLat) / 2.0;
        
        // è®¡ç®—ä¸­å¿ƒç‚¹çš„ç¬›å¡å°”åæ ‡
        const centerCartesian = Cesium.Cartesian3.fromDegrees(centerLon, centerLat);
        
        // åˆ›å»º East-North-Up (ENU) è½¬æ¢çŸ©é˜µä½œä¸ºè£å‰ªå¹³é¢çš„ modelMatrix
        // Clipping Planes å°†åœ¨è¿™ä¸ªæœ¬åœ°åæ ‡ç³»ä¸­å®šä¹‰
        const modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(centerCartesian);
        const inverseModelMatrix = Cesium.Matrix4.inverse(modelMatrix, new Cesium.Matrix4());

        // ----------------------------------------------------
        // ğŸ’¡ 3. è®¡ç®—è¾¹ç•Œç‚¹åœ¨æœ¬åœ° ENU åæ ‡ç³»ä¸­çš„ä½ç½® (X, Y)
        // ----------------------------------------------------
        
        // åŒ—è¾¹ç•Œç‚¹ (maxLat) çš„ä¸–ç•Œç¬›å¡å°”åæ ‡
        const northBoundaryCartesian = Cesium.Cartesian3.fromDegrees(centerLon, maxLat);
        // å°†å…¶è½¬æ¢åˆ°æœ¬åœ° ENU åæ ‡ç³»
        const northLocal = Cesium.Matrix4.multiplyByPoint(inverseModelMatrix, northBoundaryCartesian, new Cesium.Cartesian3());
        const Y_max = northLocal.y; // Yè½´ä»£è¡¨åŒ—æ–¹å‘

        // ä¸œè¾¹ç•Œç‚¹ (maxLon) çš„ä¸–ç•Œç¬›å¡å°”åæ ‡
        const eastBoundaryCartesian = Cesium.Cartesian3.fromDegrees(maxLon, centerLat);
        // å°†å…¶è½¬æ¢åˆ°æœ¬åœ° ENU åæ ‡ç³»
        const eastLocal = Cesium.Matrix4.multiplyByPoint(inverseModelMatrix, eastBoundaryCartesian, new Cesium.Cartesian3());
        const X_max = eastLocal.x; // Xè½´ä»£è¡¨ä¸œæ–¹å‘
        
        // ----------------------------------------------------
        // ğŸ’¡ 4. å®šä¹‰ 6 ä¸ªè£å‰ªå¹³é¢ï¼ˆå›´æˆä¸€ä¸ªç›’å­ï¼‰
        // ----------------------------------------------------
        const planes = [
            // åŒ—å¹³é¢ (Normal: +Y / North, è£å‰ª y > Y_max çš„åŒºåŸŸ)
            // å¹³é¢æ–¹ç¨‹: 1*y + D = 0. å¹³é¢åœ¨ y = Y_maxï¼Œæ‰€ä»¥ D = -Y_max
            new Cesium.ClippingPlane(new Cesium.Cartesian3(0.0, 1.0, 0.0), -Y_max), 
            
            // å—å¹³é¢ (Normal: -Y / South, è£å‰ª y < -Y_max çš„åŒºåŸŸ)
            // å¹³é¢åœ¨ y = -Y_max (å› ä¸ºY_maxæ˜¯ä¸­å¿ƒç‚¹åˆ°è¾¹ç•Œçš„è·ç¦»)ï¼Œæ‰€ä»¥ D = Y_max
            new Cesium.ClippingPlane(new Cesium.Cartesian3(0.0, -1.0, 0.0), -Y_max), 

            // ä¸œå¹³é¢ (Normal: +X / East, è£å‰ª x > X_max çš„åŒºåŸŸ)
            // å¹³é¢æ–¹ç¨‹: 1*x + D = 0. å¹³é¢åœ¨ x = X_maxï¼Œæ‰€ä»¥ D = -X_max
            new Cesium.ClippingPlane(new Cesium.Cartesian3(1.0, 0.0, 0.0), -X_max), 

            // è¥¿å¹³é¢ (Normal: -X / West, è£å‰ª x < -X_max çš„åŒºåŸŸ)
            // å¹³é¢åœ¨ x = -X_maxï¼Œæ‰€ä»¥ D = X_max
            new Cesium.ClippingPlane(new Cesium.Cartesian3(-1.0, 0.0, 0.0), -X_max), 
            
            // é¡¶å¹³é¢ (Normal: +Z / Up, è£å‰ª z > maxAltitude çš„åŒºåŸŸ)
            // Z=0 æ˜¯ä¸­å¿ƒç‚¹ï¼Œæˆ‘ä»¬å‡è®¾åœ°é¢é«˜åº¦ä¸º0ï¼Œè£å‰ªåˆ° maxAltitude
            new Cesium.ClippingPlane(new Cesium.Cartesian3(0.0, 0.0, 1.0), -maxAltitude),
            
            // åº•å¹³é¢ (Normal: -Z / Down, è£å‰ª z < 0 çš„åŒºåŸŸ)
            new Cesium.ClippingPlane(new Cesium.Cartesian3(0.0, 0.0, -1.0), 0.0), 
        ];

        // ----------------------------------------------------
        // ğŸ’¡ 5. åˆ›å»º ClippingPlaneCollection å¹¶åº”ç”¨åˆ° Tileset
        // ----------------------------------------------------
        const clippingPlanes = new Cesium.ClippingPlaneCollection({
            planes: planes,
            // å…³é”®ï¼šåº”ç”¨æœ¬åœ°åæ ‡ç³»è½¬æ¢çŸ©é˜µ
            modelMatrix: modelMatrix, 
            edgeWidth: 2.0,
            edgeColor: Cesium.Color.fromCssColorString('#00FFFF'), // é’è‰²è¾¹ç•Œ
            enabled: true,
            // å…³é”®ï¼šè®¾ç½®ä¸º falseï¼Œè¡¨ç¤ºåªä¿ç•™æ‰€æœ‰å¹³é¢å†…ä¾§çš„åŒºåŸŸ (å³ç›’å­å†…éƒ¨)
            unionClippingRegions: false 
        });

        tileset.clippingPlanes = clippingPlanes;

        // ----------------------------------------------------
        // ğŸ’¡ 6. è§†ç‚¹å®šä½åˆ°è£å‰ªåŒºåŸŸ
        // ----------------------------------------------------
        viewer.camera.flyTo({
            destination: centerCartesian,
            offset: new Cesium.HeadingPitchRange(
                Cesium.Math.toRadians(0.0), // Heading
                Cesium.Math.toRadians(-45.0), // Pitch
                1000.0 // Range (è·ç¦»ä¸­å¿ƒçš„è·ç¦»)
            )
        });
        
    
  </script>
</body>

</html>