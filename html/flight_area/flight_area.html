<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    #backButton {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      padding: 10px 20px;
      background: rgba(48, 51, 56, 0.8);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: none;
    }

    #backButton:hover {
      background: rgba(48, 51, 56, 1);
    }

    #info {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(48, 51, 56, 0.8);
      color: white;
      padding: 10px;
      border-radius: 4px;
      font-size: 12px;
      max-width: 300px;
    }

    #tooltip {
      position: absolute;
      background: rgba(48, 51, 56, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1001;
      max-width: 200px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transform: translateY(-5px);
      transition: opacity 0.3s ease;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <button id="backButton" onclick="returnToMainScene()">返回主场景</button>

  <div id="info">
    <strong>操作说明：</strong><br>
    • 点击任意起降场进入子场景<br>
    • 起降场由多个矩形起降单元组成<br>
    • 子场景中可查看起降单元详情
  </div>
  <div id="tooltip" style="display: none;"></div>

  <script type="module">
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    const terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(1, {
      requestVertexNormals: true,
      requestWaterMask: true
    });

    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrainProvider: terrainProvider,
      infoBox: false,
      selectionIndicator: false
    });

    // 全局变量
    let currentScene = 'main'; // 'main' 或 'landing'
    let mainCameraPosition = null;
    let landingFields = [];
    let currentLandingField = null;

    // 起降场数据 - 只提供一个中心点，自动布局起降单元
    const landingFieldsData = [
      {
        id: 'field1',
        name: '起降场 A',
        center: Cesium.Cartesian3.fromDegrees(119.995161825460514, 30.275375425493404, 1),
        // 不再手动指定 units，由代码自动生成
        unitLayout: {
          rows: 3,        // 行数
          cols: 4,        // 列数
          unitWidth: 30,  // 单元宽度（米）
          unitHeight: 30, // 单元高度（米）
          spacing: 5      // 单元间距（米）
        },
        weatherStations: [
          {
            id: 'ws1',
            name: '气象站 #1',
            dimensions: new Cesium.Cartesian3(5, 5, 8),
            data: {  // 将气象数据包装在data对象中
              temperature: '26°C',
              humidity: '65%',
              windSpeed: '3.2 m/s',
              windDirection: 'NE',
              pressure: '1013 hPa',
              updateTime: '2025-04-05 10:30'
            }
          }
        ]
      }
    ];

    // 创建起降场（修改版：自动布局起降单元）
    function createLandingFields() {
      landingFieldsData.forEach(fieldData => {
        const landingField = {
          id: fieldData.id,
          name: fieldData.name,
          center: fieldData.center,
          units: [],
          boundaryEntity: null,
          baseEntity: null
        };

        const centerCarto = Cesium.Cartographic.fromCartesian(fieldData.center);
        const centerLon = Cesium.Math.toDegrees(centerCarto.longitude);
        const centerLat = Cesium.Math.toDegrees(centerCarto.latitude);
        const centerHeight = centerCarto.height;

        const layout = fieldData.unitLayout;
        const { rows, cols, unitWidth, unitHeight, spacing } = layout;

        // 计算整个布局的经纬度范围（用于绘制底座）
        let west = Infinity, south = Infinity, east = -Infinity, north = -Infinity;

        // === 生成起降单元 ===
        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            // 计算当前单元中心相对于场地中心的偏移量（米）
            const offsetX = (col - (cols - 1) / 2) * (unitWidth + spacing); // 水平方向
            const offsetY = ((rows - 1) / 2 - row) * (unitHeight + spacing); // 垂直方向（北为正）

            // 将米转换为经纬度偏移（近似）
            const metersPerDegreeLat = 111320; // 纬度方向 1度 ≈ 111320 米
            const metersPerDegreeLon = 111320 * Math.cos(Cesium.Math.toRadians(centerLat)); // 经度方向随纬度变化

            const deltaLon = offsetX / metersPerDegreeLon;
            const deltaLat = offsetY / metersPerDegreeLat;

            const unitLon = centerLon + deltaLon;
            const unitLat = centerLat + deltaLat;
            const unitBaseHeight = centerHeight + 0.1; // 起降单元基础高度

            // 计算单元边界
            const halfWidthDeg = (unitWidth / 2) / metersPerDegreeLon;
            const halfHeightDeg = (unitHeight / 2) / metersPerDegreeLat;

            const unitWest = unitLon - halfWidthDeg;
            const unitEast = unitLon + halfWidthDeg;
            const unitSouth = unitLat - halfHeightDeg;
            const unitNorth = unitLat + halfHeightDeg;

            west = Math.min(west, unitWest);
            east = Math.max(east, unitEast);
            south = Math.min(south, unitSouth);
            north = Math.max(north, unitNorth);

            // 创建起降单元实体 - 使用统一的高度值
            const corners = [
              Cesium.Cartesian3.fromDegrees(unitWest, unitSouth, unitBaseHeight),
              Cesium.Cartesian3.fromDegrees(unitWest, unitNorth, unitBaseHeight),
              Cesium.Cartesian3.fromDegrees(unitEast, unitNorth, unitBaseHeight),
              Cesium.Cartesian3.fromDegrees(unitEast, unitSouth, unitBaseHeight),
              Cesium.Cartesian3.fromDegrees(unitWest, unitSouth, unitBaseHeight)
            ];

            const unitIndex = row * cols + col;
            const unit = viewer.entities.add({
              id: `${fieldData.id}_unit_${unitIndex}`,
              polygon: {
                hierarchy: corners,
                material: new Cesium.ImageMaterialProperty({
                  image: 'runway.png',
                  repeat: new Cesium.Cartesian2(1, 1),
                  color: Cesium.Color.WHITE,
                  transparent: true
                }),
                outline: true,
                outlineColor: Cesium.Color.BLUE,
                outlineWidth: 2,
                heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                extrudedHeight: unitBaseHeight + 1.5, // 挤出高度
                extrudedHeightReference: Cesium.HeightReference.RELATIVE_TO_GROUND
              },
              properties: {
                type: 'landingUnit',
                fieldId: fieldData.id,
                fieldName: fieldData.name,
                unitIndex: unitIndex,
                width: unitWidth,
                height: unitHeight
              }
            });

            // 添加编号标签 - 使用单元中心位置
            const unitPosition = Cesium.Cartesian3.fromDegrees(unitLon, unitLat, unitBaseHeight + 0.1);
            const labelEntity = viewer.entities.add({
              position: unitPosition,
              label: {
                text: '#' + (unitIndex + 1).toString(),
                font: '14pt bold sans-serif',
                fillColor: Cesium.Color.WHITE,
                outlineColor: Cesium.Color.BLACK,
                outlineWidth: 3,
                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
                pixelOffset: new Cesium.Cartesian2(0, -10),
                heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                disableDepthTestDistance: Number.POSITIVE_INFINITY
              },
              properties: {
                type: 'landingUnitLabel',
                fieldId: fieldData.id,
                unitIndex: unitIndex
              }
            });

            landingField.units.push(unit);
          }
        }

        // === 计算气象站位置（放在右上角内部）===
        const buffer = 10 / 111320;
        const baseHeight = centerHeight + 0.05; // 底座略低于起降单元

        // 计算底座边界
        const baseWest = west - buffer;
        const baseEast = east + buffer;
        const baseSouth = south - buffer;
        const baseNorth = north + buffer;

        // 计算气象站位置 - 放在右上角内部，靠近角落
        const weatherStationOffset = 5 / 111320; // 5米偏移，确保在内部
        const weatherStationLon = baseEast - weatherStationOffset;
        const weatherStationLat = baseNorth - weatherStationOffset;
        const weatherStationHeight = baseHeight + 2; // 稍微高一点

        // 创建气象站位置
        const weatherStationPosition = Cesium.Cartesian3.fromDegrees(
          weatherStationLon,
          weatherStationLat,
          weatherStationHeight
        );

        // === 创建底座 ===
        // 创建底座多边形
        const baseCorners = [
          Cesium.Cartesian3.fromDegrees(baseWest, baseSouth, baseHeight),
          Cesium.Cartesian3.fromDegrees(baseWest, baseNorth, baseHeight),
          Cesium.Cartesian3.fromDegrees(baseEast, baseNorth, baseHeight),
          Cesium.Cartesian3.fromDegrees(baseEast, baseSouth, baseHeight),
          Cesium.Cartesian3.fromDegrees(baseWest, baseSouth, baseHeight)
        ];

        const baseEntity = viewer.entities.add({
          id: `${fieldData.id}_base`,
          polygon: {
            hierarchy: new Cesium.PolygonHierarchy(baseCorners),
            material: new Cesium.ImageMaterialProperty({
              image: 'image.png',
              repeat: new Cesium.Cartesian2(1, 1),
              color: Cesium.Color.WHITE.withAlpha(0.9),
              transparent: true
            }),
            outline: true,
            outlineColor: Cesium.Color.WHITE.withAlpha(0.6),
            outlineWidth: 2,
            heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
            extrudedHeight: baseHeight + 0.1, // 轻微挤出防止穿模
            extrudedHeightReference: Cesium.HeightReference.RELATIVE_TO_GROUND
          },
          position: fieldData.center,
          properties: {
            type: 'landingBase',
            fieldId: fieldData.id
          }
        });

        landingField.baseEntity = baseEntity;

        // === 创建气象站（修改版：自动计算位置）===
        if (fieldData.weatherStations && fieldData.weatherStations.length > 0) {
          landingField.weatherStations = [];

          fieldData.weatherStations.forEach(ws => {
            const wsEntity = viewer.entities.add({
              id: `${fieldData.id}_weather_${ws.id}`,
              position: weatherStationPosition, // 使用计算出的右上角位置
              box: {
                dimensions: ws.dimensions,
                material: new Cesium.ImageMaterialProperty({
                  image: 'runway.png',
                  repeat: new Cesium.Cartesian2(1, 1),
                  color: Cesium.Color.WHITE,
                  transparent: true
                }),
                outline: true,
                outlineColor: Cesium.Color.CYAN,
                outlineWidth: 2,
                heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND
              },
              label: {
                text: ws.name,
                font: '12pt sans-serif',
                fillColor: Cesium.Color.WHITE,
                outlineColor: Cesium.Color.BLACK,
                outlineWidth: 2,
                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
                pixelOffset: new Cesium.Cartesian2(0, -6),
                heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                disableDepthTestDistance: Number.POSITIVE_INFINITY
              },
              properties: {
                type: 'weatherStation',
                fieldId: fieldData.id,
                stationId: ws.id,
                name: ws.name,
                data: ws.data  // 正确传递data对象
              }
            });

            landingField.weatherStations.push(wsEntity);
          });
        }

        // === 创建边界标识 ===
        const boundary = viewer.entities.add({
          id: `${fieldData.id}_boundary`,
          position: fieldData.center,
          label: {
            text: fieldData.name,
            font: '16pt sans-serif',
            fillColor: Cesium.Color.YELLOW,
            outlineColor: Cesium.Color.BLACK,
            outlineWidth: 2,
            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
            pixelOffset: new Cesium.Cartesian2(0, -50),
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
          },
          point: {
            pixelSize: 15,
            color: Cesium.Color.YELLOW,
            outlineColor: Cesium.Color.BLACK,
            outlineWidth: 2,
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
          },
          properties: {
            type: 'landingField',
            fieldId: fieldData.id,
            fieldName: fieldData.name
          }
        });

        landingField.boundaryEntity = boundary;
        landingFields.push(landingField);
      });
    }

    // ========== 保留原有 enterLandingFieldScene、returnToMainScene、点击事件等逻辑不变 ==========
    function enterLandingFieldScene(fieldId) {
      currentScene = 'landing';
      const field = landingFields.find(f => f.id === fieldId);
      if (!field) return;

      currentLandingField = field;

      mainCameraPosition = {
        destination: viewer.camera.position.clone(),
        orientation: {
          heading: viewer.camera.heading,
          pitch: viewer.camera.pitch,
          roll: viewer.camera.roll
        }
      };

      landingFields.forEach(otherField => {
        if (otherField.id !== fieldId) {
          otherField.boundaryEntity.show = false;
          otherField.units.forEach(unit => unit.show = false);
          if (otherField.baseEntity) otherField.baseEntity.show = false;
          if (otherField.weatherStations) {
            otherField.weatherStations.forEach(ws => ws.show = false);
          }
        }
      });

      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(
          Cesium.Math.toDegrees(Cesium.Cartographic.fromCartesian(field.center).longitude),
          Cesium.Math.toDegrees(Cesium.Cartographic.fromCartesian(field.center).latitude),
          200
        ),
        orientation: {
          heading: 0,
          pitch: Cesium.Math.toRadians(-70),
          roll: 0
        },
        duration: 2.0
      });

      document.getElementById('backButton').style.display = 'block';

      document.getElementById('info').innerHTML = `
      <strong>${field.name} 详情：</strong><br>
      • 起降单元数量: ${field.units.length}<br>
      • 场地位置: ${Cesium.Math.toDegrees(Cesium.Cartographic.fromCartesian(field.center).longitude).toFixed(4)}°, 
      ${Cesium.Math.toDegrees(Cesium.Cartographic.fromCartesian(field.center).latitude).toFixed(4)}°<br>
      • 点击起降单元查看详情
    `;
    }

    window.returnToMainScene = function () {
      currentScene = 'main';
      currentLandingField = null;

      landingFields.forEach(field => {
        field.boundaryEntity.show = true;
        field.units.forEach(unit => unit.show = true);
        if (field.baseEntity) field.baseEntity.show = true;
        if (field.weatherStations) {
          field.weatherStations.forEach(ws => ws.show = true);
        }
      });

      if (mainCameraPosition) {
        viewer.camera.flyTo({
          destination: mainCameraPosition.destination,
          orientation: mainCameraPosition.orientation,
          duration: 2.0
        });
      }

      document.getElementById('backButton').style.display = 'none';

      document.getElementById('info').innerHTML = `
      <strong>操作说明：</strong><br>
      • 点击任意起降场进入子场景<br>
      • 起降场由多个矩形起降单元组成<br>
      • 子场景中可查看起降单元详情
    `;
    };

    const tooltip = document.getElementById('tooltip');
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

    handler.setInputAction((click) => {
      const pickedObject = viewer.scene.pick(click.position);
      tooltip.style.display = 'none';

      if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id)) {
        const entity = pickedObject.id;
        const properties = entity.properties;

        if (properties && properties.type) {
          if (properties.type._value === 'landingField' && currentScene === 'main') {
            enterLandingFieldScene(properties.fieldId._value);
          }
          else if (properties.type._value === 'landingUnit' && currentScene === 'landing') {
            const unitIndex = properties.unitIndex._value;
            const fieldName = properties.fieldName._value;
            const width = properties.width._value;
            const height = properties.height._value;

            tooltip.innerHTML = `
            <strong>单元 #${unitIndex + 1}</strong><br>
            ${width}m × ${height}m<br>
            状态: 可用
          `;

            const positions = entity.polygon.hierarchy.getValue(viewer.clock.currentTime).positions;
            const boundingSphere = Cesium.BoundingSphere.fromPoints(positions);
            const position = boundingSphere.center;
            const screenPosition = viewer.scene.cartesianToCanvasCoordinates(position);

            if (Cesium.defined(screenPosition)) {
              tooltip.style.left = `${screenPosition.x}px`;
              tooltip.style.top = `${screenPosition.y - 40}px`;
              tooltip.style.display = 'block';
            }

            if (entity.polygon) {
              const originalMaterial = entity.polygon.material;
              entity.polygon.material = Cesium.Color.ORANGE.withAlpha(0.8);

              setTimeout(() => {
                entity.polygon.material = originalMaterial;
                tooltip.style.display = 'none';
              }, 2000);
            }

            document.getElementById('info').innerHTML = `
            <strong>起降单元详情：</strong><br>
            • 所属场地: ${fieldName}<br>
            • 单元编号: ${unitIndex + 1}<br>
            • 尺寸: ${width}m × ${height}m<br>
            • 状态: 可用
          `;
          }
          else if (properties.type._value === 'weatherStation' && currentScene === 'landing') {
            const stationName = properties.name._value;
            const data = properties.data._value;  // 现在可以正确访问data对象了

            tooltip.innerHTML = `
            <strong>${stationName}</strong><br>
            温度: ${data.temperature}<br>
            湿度: ${data.humidity}<br>
            风速: ${data.windSpeed}<br>
            风向: ${data.windDirection}<br>
            气压: ${data.pressure}<br>
            更新: ${data.updateTime}
          `;

            const position = entity.position.getValue(viewer.clock.currentTime);
            const screenPosition = viewer.scene.cartesianToCanvasCoordinates(position);

            if (Cesium.defined(screenPosition)) {
              tooltip.style.left = `${screenPosition.x}px`;
              tooltip.style.top = `${screenPosition.y - 60}px`;
              tooltip.style.display = 'block';
            }

            setTimeout(() => {
              tooltip.style.display = 'none';
            }, 1000);

            const carto = Cesium.Cartographic.fromCartesian(position);
            document.getElementById('info').innerHTML = `
            <strong>气象站详情：</strong><br>
            • 名称: ${stationName}<br>
            • 位置: ${Cesium.Math.toDegrees(carto.longitude).toFixed(4)}°, 
            ${Cesium.Math.toDegrees(carto.latitude).toFixed(4)}°<br>
            • 点击查看实时气象数据
          `;
          }
        }
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // ========== 加载 3D Tileset 或默认视图 ==========
    try {
      const tileset = viewer.scene.primitives.add(
        await Cesium.Cesium3DTileset.fromUrl(
          "https://gl.hangzhoudk.com/modelfile/tileset.json",
          { debugShowBoundingVolume: false }
        )
      );
      await viewer.zoomTo(tileset);
      createLandingFields();
    } catch (error) {
      console.log("无法加载3D Tileset，使用默认视图");
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(119.998060, 30.282778, 2000),
        orientation: {
          heading: 0,
          pitch: Cesium.Math.toRadians(-30),
          roll: 0
        }
      });
      createLandingFields();
    }
  </script>
</body>

</html>