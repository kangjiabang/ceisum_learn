<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebRTC æ’­æ”¾ä¿®å¤</title>
    <script src="https://cdn.jsdelivr.net/npm/webrtc-adapter@7.4.0/adapter.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #video { border: 2px solid #333; background: #000; }
        #status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>WebRTC æ’­æ”¾æµ‹è¯• - live/mystream</h1>
    <button onclick="startPlayback()">å¼€å§‹æ’­æ”¾</button>
    <button onclick="stopPlayback()">åœæ­¢æ’­æ”¾</button>
    
    <div id="status" class="info">ç‚¹å‡»"å¼€å§‹æ’­æ”¾"æŒ‰é’®</div>
    
    <video id="video" autoplay muted controls width="800" height="450"></video>
    
    <div>
        <h3>è¿æ¥ä¿¡æ¯ï¼š</h3>
        <div id="connectionInfo"></div>
    </div>

    <script>
        let pc = null;
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const connectionInfo = document.getElementById('connectionInfo');

        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = type;
            console.log(message);
        }

        function updateConnectionInfo(info) {
            connectionInfo.innerHTML = info;
        }

        async function startPlayback() {
            if (pc) {
                updateStatus('âš ï¸ å·²æœ‰è¿æ¥åœ¨è¿è¡Œ', 'error');
                return;
            }

            try {
                updateStatus('ğŸ”„ åˆå§‹åŒ– WebRTC è¿æ¥...', 'info');
                
                // åˆ›å»º PeerConnection
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                // ç›‘å¬çŠ¶æ€å˜åŒ–
                pc.onconnectionstatechange = () => {
                    const state = pc.connectionState;
                    updateConnectionInfo(`è¿æ¥çŠ¶æ€: ${state}`);
                    
                    if (state === 'connected') {
                        updateStatus('âœ… WebRTC è¿æ¥æˆåŠŸï¼', 'success');
                    } else if (state === 'failed' || state === 'disconnected') {
                        updateStatus(`âŒ è¿æ¥å¤±è´¥: ${state}`, 'error');
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    updateConnectionInfo(`ICEçŠ¶æ€: ${pc.iceConnectionState} | è¿æ¥çŠ¶æ€: ${pc.connectionState}`);
                };

                pc.onsignalingstatechange = () => {
                    updateConnectionInfo(`ä¿¡ä»¤çŠ¶æ€: ${pc.signalingState}`);
                };

                // ç›‘å¬è§†é¢‘è½¨é“
                pc.ontrack = (event) => {
                    updateStatus('ğŸ¬ æ”¶åˆ°è§†é¢‘è½¨é“ï¼', 'success');
                    if (event.streams && event.streams[0]) {
                        video.srcObject = event.streams[0];
                        updateStatus('âœ… è§†é¢‘æµå¼€å§‹æ’­æ”¾ï¼', 'success');
                    }
                };

                // æ·»åŠ æ¥æ”¶å™¨
                pc.addTransceiver('video', { direction: 'recvonly' });
                pc.addTransceiver('audio', { direction: 'recvonly' });

                // åˆ›å»º Offer
                updateStatus('ğŸ”„ åˆ›å»º WebRTC Offer...', 'info');
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                // è¿æ¥åˆ° SRS
                updateStatus('ğŸ”„ è¿æ¥åˆ° SRS WebRTC...', 'info');
                const response = await fetch('http://172.16.26.24:1985/rtc/v1/play/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api: 'http://172.16.26.24:1985/rtc/v1/play/',
                        sdp: offer.sdp,
                        streamurl: 'webrtc://172.16.26.24:1985/live/mystream'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                console.log('SRS å“åº”:', data);

                if (data.code === 0) {
                    updateStatus('âœ… WebRTC ä¿¡ä»¤äº¤æ¢æˆåŠŸï¼', 'success');
                    await pc.setRemoteDescription(new RTCSessionDescription({
                        type: 'answer',
                        sdp: data.sdp
                    }));
                } else {
                    throw new Error(`SRSé”™è¯¯: ${data.code} - ${JSON.stringify(data)}`);
                }

            } catch (error) {
                updateStatus(`âŒ é”™è¯¯: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
                
                if (pc) {
                    pc.close();
                    pc = null;
                }
            }
        }

        function stopPlayback() {
            if (pc) {
                pc.close();
                pc = null;
                video.srcObject = null;
                updateStatus('â¹ï¸ æ’­æ”¾å·²åœæ­¢', 'info');
                updateConnectionInfo('');
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', stopPlayback);
    </script>
</body>
</html>