<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Cesium.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">

    // Access token
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OGIzZmQyZC03YjNiLTQzMjQtOWQxYS0xOTYxZWUyMTYzMjQiLCJpZCI6MzEzMjQxLCJpYXQiOjE3NTAyMjc2NDd9.G9X0WofFDt3mbp2L_WDzU__rcAVg0v3rpAliG1sgB9k';

    // åœ°å½¢
    const terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(1, {
      requestVertexNormals: true,
      requestWaterMask: true
    });

    const viewer = new Cesium.Viewer("cesiumContainer", {
      shouldDebug: true,
      terrainProvider: terrainProvider
    });

    // åŠ è½½ 3D Tileset
    const tileset = viewer.scene.primitives.add(
      await Cesium.Cesium3DTileset.fromUrl("http://192.168.4.78:8000/tileset.json", {
        debugShowBoundingVolume: false,
      })
    );

    tileset.loadProgress.addEventListener((numberOfPendingRequests) => {
      console.log(`æ­£åœ¨åŠ è½½: ${numberOfPendingRequests} ä¸ªè¯·æ±‚`);
    });

    viewer.zoomTo(tileset);

    // -------------------------------
    // âœ… ä½¿ç”¨ Primitive æ‰¹é‡ç»˜åˆ¶çº¿æ¡†ç«‹æ–¹ä½“ï¼ˆæ— æŠ¥é”™ï¼‰
    // -------------------------------

    const minLat = 30.261852568883025;
    const maxLat = 30.31701791606819;
    const minLon = 119.9384401375432;
    const maxLon = 120.03013724921674;
    const cellSizeKm = 0.1;         // 100ç±³ Ã— 100ç±³
    const cellHeightM = 100;        // é«˜åº¦ 100m
    const verticalLayers = 3;       // 3 å±‚

    const dLat = cellSizeKm / 111.32;
    const refLat = (minLat + maxLat) / 2;
    const dLon = cellSizeKm / (111.32 * Math.cos(refLat * Math.PI / 180.0));

    const halfSize = cellSizeKm * 1000 / 2; // åŠè¾¹é•¿ï¼ˆç±³ï¼‰


    // æ›¿æ¢ä½ åŸæ¥çš„ lineInstances ç”Ÿæˆéƒ¨åˆ†
    const lineInstances = [];

    // å®šä¹‰ 8 ä¸ªå±€éƒ¨é¡¶ç‚¹ï¼ˆåœ¨å±€éƒ¨ ENU åæ ‡ç³»ä¸­ï¼Œå•ä½ï¼šç±³ï¼‰
    const half = cellSizeKm * 1000 / 2; // 50 ç±³
    const cornersLocal = [
      new Cesium.Cartesian3(-half, -half, -half), // å·¦å‰ä¸‹
      new Cesium.Cartesian3(half, -half, -half), // å³å‰ä¸‹
      new Cesium.Cartesian3(half, half, -half), // å³åä¸‹
      new Cesium.Cartesian3(-half, half, -half), // å·¦åä¸‹
      new Cesium.Cartesian3(-half, -half, half), // å·¦å‰ä¸Š
      new Cesium.Cartesian3(half, -half, half), // å³å‰ä¸Š
      new Cesium.Cartesian3(half, half, half), // å³åä¸Š
      new Cesium.Cartesian3(-half, half, half)  // å·¦åä¸Š
    ];

    const edges = [
      [0, 1], [1, 2], [2, 3], [3, 0], // åº•é¢
      [4, 5], [5, 6], [6, 7], [7, 4], // é¡¶é¢
      [0, 4], [1, 5], [2, 6], [3, 7]  // å‚ç›´è¾¹
    ];

    for (let lat = minLat; lat < maxLat; lat += dLat) {
      for (let lon = minLon; lon < maxLon; lon += dLon) {
        const latCenter = lat + dLat / 2;
        const lonCenter = lon + dLon / 2;

        for (let k = 0; k < verticalLayers; k++) {
          const height = k * cellHeightM + cellHeightM / 2;

          // ğŸ‘‰ å…³é”®ï¼šä½¿ç”¨ cartographic + å˜æ¢çŸ©é˜µ
          const cartographic = new Cesium.Cartographic(
            Cesium.Math.toRadians(lonCenter),
            Cesium.Math.toRadians(latCenter),
            height
          );

          // åˆ›å»ºä» ENUï¼ˆä¸œ-åŒ—-ä¸Šï¼‰åˆ° ECEF çš„å˜æ¢çŸ©é˜µ
          const enuToEcef = Cesium.Transforms.eastNorthUpToFixedFrame(
            Cesium.Cartographic.toCartesian(cartographic)
          );

          // å°†å±€éƒ¨é¡¶ç‚¹è½¬æ¢åˆ°ä¸–ç•Œåæ ‡ï¼ˆECEFï¼‰
          const worldCorners = cornersLocal.map(localPoint => {
            const worldPoint = new Cesium.Cartesian3();
            Cesium.Matrix4.multiplyByPoint(enuToEcef, localPoint, worldPoint);
            return worldPoint;
          });

          // æ·»åŠ  12 æ¡è¾¹
          for (const [i, j] of edges) {
            lineInstances.push(new Cesium.GeometryInstance({
              geometry: new Cesium.PolylineGeometry({
                positions: [worldCorners[i], worldCorners[j]],
                width: 1
              }),
              attributes: {
                color: Cesium.ColorGeometryInstanceAttribute.fromColor(
                  Cesium.Color.WHITE.withAlpha(0.15)
                )
              }
            }));
          }
        }
      }
    }
    // åˆ›å»º Primitive æ‰¹é‡æ¸²æŸ“æ‰€æœ‰çº¿æ®µ
    const primitive = new Cesium.Primitive({
      geometryInstances: lineInstances,
      appearance: new Cesium.PolylineColorAppearance({
        translucent: true
      })
    });

    viewer.scene.primitives.add(primitive);
    //viewer.zoomTo(primitive);

  </script>
</body>

</html>